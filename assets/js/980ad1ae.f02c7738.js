"use strict";(self.webpackChunkgosoline_docs=self.webpackChunkgosoline_docs||[]).push([["3139"],{2242(e,n,t){t.r(n),t.d(n,{metadata:()=>r,default:()=>u,frontMatter:()=>d,contentTitle:()=>l,toc:()=>h,assets:()=>c});var r=JSON.parse('{"id":"how-to/databases-sql/sqlr","title":"sqlr - SQL Repository","description":"The sqlr package provides a generic, type-safe repository layer built on top of sqlc. It offers CRUD operations, relationship management, eager loading via joins and preloads, and transaction support \u2014 all using Go generics for compile-time type safety.","source":"@site/docs/how-to/databases-sql/sqlr.mdx","sourceDirName":"how-to/databases-sql","slug":"/how-to/databases-sql/sqlr","permalink":"/docs/how-to/databases-sql/sqlr","draft":false,"unlisted":false,"editUrl":"https://github.com/gosoline-project/docs/tree/main/docs/how-to/databases-sql/sqlr.mdx","tags":[],"version":"current","sidebarPosition":2,"frontMatter":{"sidebar_position":2,"title":"sqlr - SQL Repository"},"sidebar":"docSidebar","previous":{"title":"sqlc - SQL Client","permalink":"/docs/how-to/databases-sql/sqlc"},"next":{"title":"sqlh - SQL HTTP Handlers","permalink":"/docs/how-to/databases-sql/sqlh"}}'),i=t(4848),s=t(8453),o=t(4490);let a='package main\n\nimport (\n	"context"\n	_ "embed"\n	"errors"\n	"fmt"\n\n	"github.com/gosoline-project/sqlc"\n	"github.com/gosoline-project/sqlr"\n	"github.com/justtrackio/gosoline/pkg/application"\n	"github.com/justtrackio/gosoline/pkg/cfg"\n	"github.com/justtrackio/gosoline/pkg/kernel"\n	gosolineLog "github.com/justtrackio/gosoline/pkg/log"\n)\n\n// snippet-start: entities\ntype Author struct {\n	sqlr.Entity[int64]\n	Name  string `db:"name"`\n	Email string `db:"email"`\n	Posts []Post `db:"-,foreignKey:author_id"`\n}\n\ntype Post struct {\n	sqlr.Entity[int64]\n	AuthorID int64  `db:"author_id"`\n	Title    string `db:"title"`\n	Body     string `db:"body"`\n	Status   string `db:"status"`\n	Author   Author `db:"-,belongsTo:author_id"`\n	Tags     []Tag  `db:"-,many2many:post_tags"`\n}\n\ntype Tag struct {\n	sqlr.Entity[int64]\n	Name string `db:"name"`\n}\n\n// snippet-end: entities\n\n// snippet-start: entity auto-preload\ntype PostWithPreloads struct {\n	sqlr.Entity[int64]\n	AuthorID int64  `db:"author_id"`\n	Title    string `db:"title"`\n	Body     string `db:"body"`\n	Status   string `db:"status"`\n	Author   Author `db:"-,belongsTo:author_id,preload"`\n	Tags     []Tag  `db:"-,many2many:post_tags,preload"`\n}\n\n// snippet-end: entity auto-preload\n\n//go:embed config.dist.yml\nvar config []byte\n\nfunc main() {\n	application.RunFunc(\n		func(ctx context.Context, config cfg.Config, logger gosolineLog.Logger) (kernel.ModuleRunFunc, error) {\n			// snippet-start: create repository\n			authorRepo, err := sqlr.NewRepository[int64, Author](ctx, config, logger, "default")\n			if err != nil {\n				return nil, fmt.Errorf("failed to create author repository: %w", err)\n			}\n			// snippet-end: create repository\n\n			postRepo, err := sqlr.NewRepository[int64, Post](ctx, config, logger, "default")\n			if err != nil {\n				return nil, fmt.Errorf("failed to create post repository: %w", err)\n			}\n\n			tagRepo, err := sqlr.NewRepository[int64, Tag](ctx, config, logger, "default")\n			if err != nil {\n				return nil, fmt.Errorf("failed to create tag repository: %w", err)\n			}\n\n			service := &BlogService{\n				authorRepo: authorRepo,\n				postRepo:   postRepo,\n				tagRepo:    tagRepo,\n			}\n\n			return func(ctx context.Context) error {\n				// Create entities\n				alice, err := service.createAuthor(ctx, "Alice", "alice-@mail.io")\n				if err != nil {\n					return fmt.Errorf("failed to create author: %w", err)\n				}\n				logger.Info(ctx, "created author: %s (id=%d)", alice.Name, alice.Id)\n\n				post, err := service.createPost(ctx, alice.Id, "Hello World", "My first post!", "draft", Tag{Name: "golang"})\n				if err != nil {\n					return fmt.Errorf("failed to create post: %w", err)\n				}\n				logger.Info(ctx, "created post: %s (id=%d) with %d tag(s)", post.Title, post.Id, len(post.Tags))\n\n				// Read by ID\n				readAuthor, err := service.readAuthor(ctx, alice.Id)\n				if err != nil {\n					return fmt.Errorf("failed to read author: %w", err)\n				}\n				logger.Info(ctx, "read author: %s", readAuthor.Name)\n\n				// Read with joins\n				readPost, err := service.readPostWithAuthor(ctx, post.Id)\n				if err != nil {\n					return fmt.Errorf("failed to read post with author: %w", err)\n				}\n				logger.Info(ctx, "read post with author: %s by %s", readPost.Title, readPost.Author.Name)\n\n				// Update entity\n				updatedPost, err := service.updatePostStatus(ctx, post, "published")\n				if err != nil {\n					return fmt.Errorf("failed to update post: %w", err)\n				}\n				logger.Info(ctx, "updated post status to: %s", updatedPost.Status)\n\n				// Query with filtering\n				posts, err := service.queryPublishedPosts(ctx)\n				if err != nil {\n					return fmt.Errorf("failed to query posts: %w", err)\n				}\n				logger.Info(ctx, "found %d published posts", len(posts))\n\n				// Query with preloading\n				postsWithAuthor, err := service.queryPostsWithAuthor(ctx)\n				if err != nil {\n					return fmt.Errorf("failed to query posts with author: %w", err)\n				}\n				logger.Info(ctx, "found %d posts with author preloaded", len(postsWithAuthor))\n\n				// Query with joins\n				postsWithJoin, err := service.queryPostsWithAuthorJoin(ctx)\n				if err != nil {\n					return fmt.Errorf("failed to query posts with join: %w", err)\n				}\n				logger.Info(ctx, "found %d posts with author joined", len(postsWithJoin))\n\n				// Query with preload condition\n				postsWithPreloadCond, err := service.queryPostsPreloadWithCondition(ctx)\n				if err != nil {\n					return fmt.Errorf("failed to query posts with preload condition: %w", err)\n				}\n				logger.Info(ctx, "found %d posts with conditional preload", len(postsWithPreloadCond))\n\n				// Query with join condition\n				postsWithJoinCond, err := service.queryPostsJoinWithCondition(ctx)\n				if err != nil {\n					return fmt.Errorf("failed to query posts with join condition: %w", err)\n				}\n				logger.Info(ctx, "found %d posts with conditional join", len(postsWithJoinCond))\n\n				// Delete entity\n				if err = service.deleteTag(ctx, post.Tags[0].Id); err != nil {\n					return fmt.Errorf("failed to delete tag: %w", err)\n				}\n				logger.Info(ctx, "deleted tag %d", post.Tags[0].Id)\n\n				// Error handling\n				_, err = service.readAuthor(ctx, 999999)\n				if errors.Is(err, sqlr.ErrNotFound) {\n					logger.Info(ctx, "author 999999 not found (as expected)")\n				}\n\n				return nil\n			}, nil\n		},\n		application.WithConfigBytes(config, "yml"),\n	)\n}\n\ntype BlogService struct {\n	authorRepo sqlr.Repository[int64, Author]\n	postRepo   sqlr.Repository[int64, Post]\n	tagRepo    sqlr.Repository[int64, Tag]\n}\n\n// snippet-start: create\nfunc (s *BlogService) createAuthor(ctx context.Context, name, email string) (*Author, error) {\n	author := &Author{\n		Name:  name,\n		Email: email,\n	}\n\n	if err := s.authorRepo.Create(ctx, author); err != nil {\n		return nil, fmt.Errorf("failed to create author: %w", err)\n	}\n\n	// author.Id is automatically set for auto-increment primary keys\n	// author.CreatedAt and author.UpdatedAt are set via autoCreateTime/autoUpdateTime\n\n	return author, nil\n}\n\n// snippet-end: create\n\n// snippet-start: create with associations\nfunc (s *BlogService) createPost(ctx context.Context, authorId int64, title, body, status string, tags ...Tag) (*Post, error) {\n	post := &Post{\n		AuthorID: authorId,\n		Title:    title,\n		Body:     body,\n		Status:   status,\n		Tags:     tags,\n	}\n\n	// When Tags is populated, sqlr automatically inserts the tag rows and\n	// the post_tags join table entries within a single transaction.\n	if err := s.postRepo.Create(ctx, post); err != nil {\n		return nil, fmt.Errorf("failed to create post: %w", err)\n	}\n\n	return post, nil\n}\n\n// snippet-end: create with associations\n\nfunc (s *BlogService) createTag(ctx context.Context, name string) (*Tag, error) {\n	tag := &Tag{\n		Name: name,\n	}\n\n	if err := s.tagRepo.Create(ctx, tag); err != nil {\n		return nil, fmt.Errorf("failed to create tag: %w", err)\n	}\n\n	return tag, nil\n}\n\n// snippet-start: read\nfunc (s *BlogService) readAuthor(ctx context.Context, id int64) (*Author, error) {\n	author, err := s.authorRepo.Read(ctx, id)\n	if err != nil {\n		return nil, fmt.Errorf("failed to read author: %w", err)\n	}\n\n	return author, nil\n}\n\n// snippet-end: read\n\n// snippet-start: read with join\nfunc (s *BlogService) readPostWithAuthor(ctx context.Context, postId int64) (*Post, error) {\n	post, err := s.postRepo.Read(ctx, postId, func(qb *sqlr.QueryBuilderRead) {\n		qb.LeftJoin("Author")\n	})\n	if err != nil {\n		return nil, fmt.Errorf("failed to read post with author: %w", err)\n	}\n\n	return post, nil\n}\n\n// snippet-end: read with join\n\n// snippet-start: update\nfunc (s *BlogService) updatePostStatus(ctx context.Context, post *Post, status string) (*Post, error) {\n	post.Status = status\n\n	updated, err := s.postRepo.Update(ctx, post)\n	if err != nil {\n		return nil, fmt.Errorf("failed to update post: %w", err)\n	}\n\n	// updated.UpdatedAt is automatically refreshed via autoUpdateTime\n\n	return updated, nil\n}\n\n// snippet-end: update\n\n// snippet-start: delete\nfunc (s *BlogService) deleteTag(ctx context.Context, id int64) error {\n	if err := s.tagRepo.Delete(ctx, id); err != nil {\n		return fmt.Errorf("failed to delete tag: %w", err)\n	}\n\n	return nil\n}\n\n// snippet-end: delete\n\n// snippet-start: query\nfunc (s *BlogService) queryPublishedPosts(ctx context.Context) ([]Post, error) {\n	posts, err := s.postRepo.Query(ctx, func(qb *sqlr.QueryBuilderSelect) {\n		qb.Where(sqlc.Col("status").Eq("published")).\n			OrderBy("created_at DESC").\n			Limit(10).\n			Offset(0)\n	})\n	if err != nil {\n		return nil, fmt.Errorf("failed to query posts: %w", err)\n	}\n\n	return posts, nil\n}\n\n// snippet-end: query\n\n// snippet-start: query preload\nfunc (s *BlogService) queryPostsWithAuthor(ctx context.Context) ([]Post, error) {\n	posts, err := s.postRepo.Query(ctx, func(qb *sqlr.QueryBuilderSelect) {\n		qb.Where(sqlc.Col("status").Eq("published")).\n			Preload("Author").\n			Preload("Tags")\n	})\n	if err != nil {\n		return nil, fmt.Errorf("failed to query posts: %w", err)\n	}\n\n	// Each post now has post.Author and post.Tags populated\n\n	return posts, nil\n}\n\n// snippet-end: query preload\n\n// snippet-start: query join\nfunc (s *BlogService) queryPostsWithAuthorJoin(ctx context.Context) ([]Post, error) {\n	posts, err := s.postRepo.Query(ctx, func(qb *sqlr.QueryBuilderSelect) {\n		qb.Where(sqlc.Col("status").Eq("published")).\n			LeftJoin("Author")\n	})\n	if err != nil {\n		return nil, fmt.Errorf("failed to query posts: %w", err)\n	}\n\n	// Each post now has post.Author populated via a SQL JOIN\n\n	return posts, nil\n}\n\n// snippet-end: query join\n\n// snippet-start: query preload condition\nfunc (s *BlogService) queryPostsPreloadWithCondition(ctx context.Context) ([]Post, error) {\n	posts, err := s.postRepo.Query(ctx, func(qb *sqlr.QueryBuilderSelect) {\n		qb.Preload("Author").Preload("Tags", sqlr.Condition(sqlc.Col("name").NotEq("")))\n	})\n	if err != nil {\n		return nil, fmt.Errorf("failed to query posts: %w", err)\n	}\n\n	return posts, nil\n}\n\n// snippet-end: query preload condition\n\n// snippet-start: query join condition\nfunc (s *BlogService) queryPostsJoinWithCondition(ctx context.Context) ([]Post, error) {\n	posts, err := s.postRepo.Query(ctx, func(qb *sqlr.QueryBuilderSelect) {\n		qb.LeftJoin("Author", sqlr.Condition(sqlc.Col("name").Eq("Alice")))\n	})\n	if err != nil {\n		return nil, fmt.Errorf("failed to query posts: %w", err)\n	}\n\n	return posts, nil\n}\n\n// snippet-end: query join condition\n',d={sidebar_position:2,title:"sqlr - SQL Repository"},l,c={},h=[{value:"Getting Started",id:"getting-started",level:2},{value:"Configuration",id:"configuration",level:2},{value:"Defining Entities",id:"defining-entities",level:2},{value:"Entity Base Struct",id:"entity-base-struct",level:3},{value:"Struct Tags",id:"struct-tags",level:3},{value:"Table Name Derivation",id:"table-name-derivation",level:3},{value:"Supported Key Types",id:"supported-key-types",level:3},{value:"Relationships",id:"relationships",level:2},{value:"HasOne / HasMany",id:"hasone--hasmany",level:3},{value:"BelongsTo",id:"belongsto",level:3},{value:"ManyToMany",id:"manytomany",level:3},{value:"Creating the Repository",id:"creating-the-repository",level:2},{value:"CRUD Operations",id:"crud-operations",level:2},{value:"Create",id:"create",level:3},{value:"Create with Associations",id:"create-with-associations",level:3},{value:"Read",id:"read",level:3},{value:"Update",id:"update",level:3},{value:"Delete",id:"delete",level:3},{value:"Query Operations",id:"query-operations",level:2},{value:"Eager Loading with Preload",id:"eager-loading-with-preload",level:2},{value:"Nested Preloads",id:"nested-preloads",level:3},{value:"Auto-Preload",id:"auto-preload",level:3},{value:"Preload Conditions",id:"preload-conditions",level:3},{value:"Eager Loading with Joins",id:"eager-loading-with-joins",level:2},{value:"Joins on Query",id:"joins-on-query",level:3},{value:"Joins on Read",id:"joins-on-read",level:3},{value:"Join Conditions",id:"join-conditions",level:3},{value:"Error Handling",id:"error-handling",level:2}];function p(e){let n={a:"a",code:"code",h2:"h2",h3:"h3",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",...(0,s.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsxs)(n.p,{children:["The ",(0,i.jsx)(n.code,{children:"sqlr"})," package provides a generic, type-safe repository layer built on top of ",(0,i.jsx)(n.a,{href:"/docs/how-to/databases-sql/sqlc",children:(0,i.jsx)(n.code,{children:"sqlc"})}),". It offers CRUD operations, relationship management, eager loading via joins and preloads, and transaction support \u2014 all using Go generics for compile-time type safety."]}),"\n",(0,i.jsx)(n.h2,{id:"getting-started",children:"Getting Started"}),"\n",(0,i.jsx)(n.p,{children:"Add the dependency to your Go module:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"go get github.com/gosoline-project/sqlr@v0.1.0\n"})}),"\n",(0,i.jsx)(n.p,{children:"Then import the package in your Go code:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-go",children:'import "github.com/gosoline-project/sqlr"\n'})}),"\n",(0,i.jsx)(n.h2,{id:"configuration",children:"Configuration"}),"\n",(0,i.jsxs)(n.p,{children:["The ",(0,i.jsx)(n.code,{children:"sqlr"})," package uses ",(0,i.jsx)(n.code,{children:"sqlc"})," under the hood for database connections. Configure your database using the same ",(0,i.jsx)(n.code,{children:"sqlc"})," configuration key described in the ",(0,i.jsx)(n.a,{href:"/docs/how-to/databases-sql/sqlc#configuration",children:"sqlc documentation"}),":"]}),"\n",(0,i.jsx)(o.N,{title:"config.dist.yml",language:"yaml",snippet:"config",children:"env: dev\n\napp_project: gosoline\napp_family: docs\napp_group: database-sql\napp_name: sqlr\n\nlog:\n  handlers:\n    main:\n      level: debug\n\n# snippet-start: config\nsqlc:\n  default:\n    driver: mysql\n    uri:\n      host: 127.0.0.1\n      port: 3306\n      user: root\n      password: gosoline\n      database: blog\n    migrations:\n      enabled: true\n      path: migrations\n# snippet-end: config\n"}),"\n",(0,i.jsx)(n.h2,{id:"defining-entities",children:"Defining Entities"}),"\n",(0,i.jsxs)(n.p,{children:["Entities are Go structs that map to database tables. Embed ",(0,i.jsx)(n.code,{children:"sqlr.Entity[K]"})," to get a primary key (",(0,i.jsx)(n.code,{children:"Id"}),"), and automatic timestamp fields (",(0,i.jsx)(n.code,{children:"CreatedAt"}),", ",(0,i.jsx)(n.code,{children:"UpdatedAt"}),"):"]}),"\n",(0,i.jsx)(o.N,{title:"main.go",language:"go",snippet:"entities",children:a}),"\n",(0,i.jsx)(n.h3,{id:"entity-base-struct",children:"Entity Base Struct"}),"\n",(0,i.jsxs)(n.p,{children:["The ",(0,i.jsx)(n.code,{children:"sqlr.Entity[K]"})," base struct provides:"]}),"\n",(0,i.jsxs)(n.table,{children:[(0,i.jsx)(n.thead,{children:(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.th,{children:"Field"}),(0,i.jsx)(n.th,{children:"Tag"}),(0,i.jsx)(n.th,{children:"Description"})]})}),(0,i.jsxs)(n.tbody,{children:[(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"Id"})}),(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:'db:"id,primaryKey"'})}),(0,i.jsx)(n.td,{children:"Primary key, auto-increment for integer types"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"CreatedAt"})}),(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:'db:"created_at,autoCreateTime"'})}),(0,i.jsx)(n.td,{children:"Set automatically on insert"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"UpdatedAt"})}),(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:'db:"updated_at,autoUpdateTime"'})}),(0,i.jsx)(n.td,{children:"Set automatically on insert and update"})]})]})]}),"\n",(0,i.jsxs)(n.p,{children:["All entities must implement the ",(0,i.jsx)(n.code,{children:"Entitier[K]"})," interface (satisfied automatically by embedding ",(0,i.jsx)(n.code,{children:"Entity[K]"}),"):"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-go",children:"type Entitier[K KeyTypes] interface {\n    GetId() K\n    GetUpdatedAt() time.Time\n    GetCreatedAt() time.Time\n}\n"})}),"\n",(0,i.jsx)(n.h3,{id:"struct-tags",children:"Struct Tags"}),"\n",(0,i.jsxs)(n.p,{children:["Column mappings and behavior are controlled via the ",(0,i.jsx)(n.code,{children:"db"})," struct tag:"]}),"\n",(0,i.jsxs)(n.table,{children:[(0,i.jsx)(n.thead,{children:(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.th,{children:"Tag"}),(0,i.jsx)(n.th,{children:"Description"})]})}),(0,i.jsxs)(n.tbody,{children:[(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:'db:"column_name"'})}),(0,i.jsx)(n.td,{children:"Maps the field to a database column"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:'db:"column_name,primaryKey"'})}),(0,i.jsx)(n.td,{children:"Marks the field as the primary key"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:'db:"column_name,autoCreateTime"'})}),(0,i.jsxs)(n.td,{children:["Auto-sets the field to ",(0,i.jsx)(n.code,{children:"time.Now()"})," on insert"]})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:'db:"column_name,autoUpdateTime"'})}),(0,i.jsxs)(n.td,{children:["Auto-sets the field to ",(0,i.jsx)(n.code,{children:"time.Now()"})," on insert and update"]})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:'db:"-,foreignKey:col"'})}),(0,i.jsxs)(n.td,{children:["Defines a HasOne or HasMany relationship (see ",(0,i.jsx)(n.a,{href:"#relationships",children:"Relationships"}),")"]})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:'db:"-,belongsTo:col"'})}),(0,i.jsx)(n.td,{children:"Defines a BelongsTo relationship"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:'db:"-,many2many:table"'})}),(0,i.jsx)(n.td,{children:"Defines a ManyToMany relationship"})]})]})]}),"\n",(0,i.jsx)(n.h3,{id:"table-name-derivation",children:"Table Name Derivation"}),"\n",(0,i.jsx)(n.p,{children:"Table names are automatically derived from the struct type name by converting PascalCase to snake_case and pluralizing:"}),"\n",(0,i.jsxs)(n.table,{children:[(0,i.jsx)(n.thead,{children:(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.th,{children:"Struct Name"}),(0,i.jsx)(n.th,{children:"Table Name"})]})}),(0,i.jsxs)(n.tbody,{children:[(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"Author"})}),(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"authors"})})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"Post"})}),(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"posts"})})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"PostTag"})}),(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"post_tags"})})]})]})]}),"\n",(0,i.jsxs)(n.p,{children:["To override the default table name, implement the ",(0,i.jsx)(n.code,{children:"TableNamer"})," interface:"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-go",children:'type TableNamer interface {\n    TableName() string\n}\n\nfunc (a Author) TableName() string {\n    return "my_authors"\n}\n'})}),"\n",(0,i.jsx)(n.h3,{id:"supported-key-types",children:"Supported Key Types"}),"\n",(0,i.jsx)(n.p,{children:"Primary keys can be any of these types (or their pointer variants):"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-go",children:"bool | string | int | int64 | uint | uint64 | float32 | float64\n"})}),"\n",(0,i.jsxs)(n.p,{children:["Integer primary key types (",(0,i.jsx)(n.code,{children:"int"}),", ",(0,i.jsx)(n.code,{children:"int64"}),", ",(0,i.jsx)(n.code,{children:"uint"}),", ",(0,i.jsx)(n.code,{children:"uint64"}),") are automatically treated as auto-increment \u2014 they are excluded from INSERT statements and their value is set from ",(0,i.jsx)(n.code,{children:"LastInsertId()"})," after creation."]}),"\n",(0,i.jsx)(n.h2,{id:"relationships",children:"Relationships"}),"\n",(0,i.jsxs)(n.p,{children:["Relationships are declared using ",(0,i.jsx)(n.code,{children:"db"})," struct tags with a ",(0,i.jsx)(n.code,{children:"-"})," column name (since relationship fields don't map to a direct column):"]}),"\n",(0,i.jsx)(n.h3,{id:"hasone--hasmany",children:"HasOne / HasMany"}),"\n",(0,i.jsxs)(n.p,{children:["Use ",(0,i.jsx)(n.code,{children:"foreignKey:column"})," to define a relationship where the foreign key lives on the ",(0,i.jsx)(n.strong,{children:"related"})," table. The relationship type is inferred from the field type \u2014 a single struct for HasOne, a slice for HasMany:"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-go",children:'type Author struct {\n    sqlr.Entity[int64]\n    Name    string  `db:"name"`\n    Profile Profile `db:"-,foreignKey:author_id"` // HasOne\n    Posts   []Post  `db:"-,foreignKey:author_id"` // HasMany\n}\n'})}),"\n",(0,i.jsx)(n.h3,{id:"belongsto",children:"BelongsTo"}),"\n",(0,i.jsxs)(n.p,{children:["Use ",(0,i.jsx)(n.code,{children:"belongsTo:column"})," when the foreign key lives on the ",(0,i.jsx)(n.strong,{children:"current"})," entity's table:"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-go",children:'type Post struct {\n    sqlr.Entity[int64]\n    AuthorID int64  `db:"author_id"`\n    Author   Author `db:"-,belongsTo:author_id"` // BelongsTo\n}\n'})}),"\n",(0,i.jsx)(n.h3,{id:"manytomany",children:"ManyToMany"}),"\n",(0,i.jsxs)(n.p,{children:["Use ",(0,i.jsx)(n.code,{children:"many2many:join_table"})," for many-to-many relationships through a join table:"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-go",children:'type Post struct {\n    sqlr.Entity[int64]\n    Tags []Tag `db:"-,many2many:post_tags"` // ManyToMany\n}\n'})}),"\n",(0,i.jsxs)(n.p,{children:["The join table (",(0,i.jsx)(n.code,{children:"post_tags"}),") must have columns named after the primary key columns of both tables (e.g., ",(0,i.jsx)(n.code,{children:"post_id"})," and ",(0,i.jsx)(n.code,{children:"tag_id"}),")."]}),"\n",(0,i.jsx)(n.h2,{id:"creating-the-repository",children:"Creating the Repository"}),"\n",(0,i.jsxs)(n.p,{children:["Create a repository using ",(0,i.jsx)(n.code,{children:"sqlr.NewRepository[K, E]()"})," within a gosoline application. The type parameters specify the primary key type and the entity type:"]}),"\n",(0,i.jsx)(o.N,{title:"main.go",language:"go",snippet:"create repository",children:a}),"\n",(0,i.jsxs)(n.p,{children:["The last argument (",(0,i.jsx)(n.code,{children:'"default"'})," above) is the ",(0,i.jsx)(n.strong,{children:"sqlc client name"}),". It must match a key under the ",(0,i.jsx)(n.code,{children:"sqlc"})," block in your configuration file \u2014 the repository uses that named client for all database operations. You can have multiple repositories pointing to different clients (e.g., ",(0,i.jsx)(n.code,{children:'"default"'}),", ",(0,i.jsx)(n.code,{children:'"analytics"'}),", ",(0,i.jsx)(n.code,{children:'"readonly"'}),") by passing different names."]}),"\n",(0,i.jsxs)(n.p,{children:["The ",(0,i.jsx)(n.code,{children:"Repository"})," interface provides:"]}),"\n",(0,i.jsxs)(n.table,{children:[(0,i.jsx)(n.thead,{children:(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.th,{children:"Method"}),(0,i.jsx)(n.th,{children:"Description"})]})}),(0,i.jsxs)(n.tbody,{children:[(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"Create(ctx, entity)"})}),(0,i.jsx)(n.td,{children:"Inserts the entity and any populated association fields; sets auto-increment IDs and timestamps"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"Read(ctx, id, opts...)"})}),(0,i.jsx)(n.td,{children:"Loads one entity by primary key, with optional joins/preloads"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"Query(ctx, opts...)"})}),(0,i.jsx)(n.td,{children:"Loads entities matching query conditions"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"Update(ctx, entity)"})}),(0,i.jsx)(n.td,{children:"Updates all fields of the entity"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"Delete(ctx, id)"})}),(0,i.jsx)(n.td,{children:"Deletes the entity by primary key"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"Close()"})}),(0,i.jsx)(n.td,{children:"Releases resources (prepared statements, etc.)"})]})]})]}),"\n",(0,i.jsx)(n.h2,{id:"crud-operations",children:"CRUD Operations"}),"\n",(0,i.jsx)(n.h3,{id:"create",children:"Create"}),"\n",(0,i.jsx)(n.p,{children:"Pass a pointer to an entity. Auto-increment IDs and timestamp fields are set automatically:"}),"\n",(0,i.jsx)(o.N,{title:"main.go",language:"go",snippet:"create",children:a}),"\n",(0,i.jsx)(n.h3,{id:"create-with-associations",children:"Create with Associations"}),"\n",(0,i.jsxs)(n.p,{children:["Populate relationship fields on the entity before calling ",(0,i.jsx)(n.code,{children:"Create()"})," and ",(0,i.jsx)(n.code,{children:"sqlr"})," will automatically persist them in the correct order within a single transaction:"]}),"\n",(0,i.jsx)(o.N,{title:"main.go",language:"go",snippet:"create with associations",children:a}),"\n",(0,i.jsx)(n.p,{children:"The association save order is:"}),"\n",(0,i.jsxs)(n.ol,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"BelongsTo"})," \u2014 related entity inserted first so the parent's FK column is set before the parent row is written."]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Parent entity"})," \u2014 the base row is inserted."]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"HasOne / HasMany"})," \u2014 related entities are inserted with their FK pointing to the parent PK."]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"ManyToMany"})," \u2014 related entities with zero PKs are inserted, then join table rows are created for all of them."]}),"\n"]}),"\n",(0,i.jsxs)(n.p,{children:["Entities with a non-zero primary key are treated as already-persisted: they are skipped for insertion but the FK or join table row is still created. ",(0,i.jsx)(n.code,{children:"Update"})," and ",(0,i.jsx)(n.code,{children:"Delete"})," only affect the base entity row and are not association-aware."]}),"\n",(0,i.jsx)(n.h3,{id:"read",children:"Read"}),"\n",(0,i.jsx)(n.p,{children:"Load a single entity by its primary key:"}),"\n",(0,i.jsx)(o.N,{title:"main.go",language:"go",snippet:"read",children:a}),"\n",(0,i.jsx)(n.h3,{id:"update",children:"Update"}),"\n",(0,i.jsxs)(n.p,{children:["Modify the entity and pass it to ",(0,i.jsx)(n.code,{children:"Update()"}),". The ",(0,i.jsx)(n.code,{children:"UpdatedAt"})," timestamp is refreshed automatically:"]}),"\n",(0,i.jsx)(o.N,{title:"main.go",language:"go",snippet:"update",children:a}),"\n",(0,i.jsx)(n.h3,{id:"delete",children:"Delete"}),"\n",(0,i.jsxs)(n.p,{children:["Remove an entity by its primary key. Returns ",(0,i.jsx)(n.code,{children:"ErrNotFound"})," if the entity doesn't exist:"]}),"\n",(0,i.jsx)(o.N,{title:"main.go",language:"go",snippet:"delete",children:a}),"\n",(0,i.jsx)(n.h2,{id:"query-operations",children:"Query Operations"}),"\n",(0,i.jsxs)(n.p,{children:["Use ",(0,i.jsx)(n.code,{children:"Query()"})," with a ",(0,i.jsx)(n.code,{children:"QueryBuilderSelect"})," to filter, sort, and paginate results:"]}),"\n",(0,i.jsx)(o.N,{title:"main.go",language:"go",snippet:"query",children:a}),"\n",(0,i.jsxs)(n.p,{children:["The ",(0,i.jsx)(n.code,{children:"QueryBuilderSelect"})," supports:"]}),"\n",(0,i.jsxs)(n.table,{children:[(0,i.jsx)(n.thead,{children:(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.th,{children:"Method"}),(0,i.jsx)(n.th,{children:"Description"})]})}),(0,i.jsxs)(n.tbody,{children:[(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"Where(condition, params...)"})}),(0,i.jsx)(n.td,{children:"Adds a WHERE condition (multiple calls are ANDed)"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"OrderBy(cols...)"})}),(0,i.jsx)(n.td,{children:"Sets the ORDER BY clause"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"Limit(n)"})}),(0,i.jsx)(n.td,{children:"Limits the number of results"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"Offset(n)"})}),(0,i.jsx)(n.td,{children:"Skips the first n results"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"GroupBy(cols...)"})}),(0,i.jsx)(n.td,{children:"Sets the GROUP BY clause"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"Having(condition, params...)"})}),(0,i.jsx)(n.td,{children:"Adds a HAVING condition"})]})]})]}),"\n",(0,i.jsxs)(n.p,{children:["WHERE conditions use the same ",(0,i.jsx)(n.code,{children:"sqlc.Col()"})," expression API from the ",(0,i.jsxs)(n.a,{href:"/docs/how-to/databases-sql/sqlc",children:[(0,i.jsx)(n.code,{children:"sqlc"})," package"]}),":"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-go",children:'qb.Where(sqlc.Col("status").Eq("published"))\nqb.Where(sqlc.Col("age").Gt(18))\nqb.Where(sqlc.And(sqlc.Col("a").Eq(1), sqlc.Col("b").Eq(2)))\n'})}),"\n",(0,i.jsx)(n.h2,{id:"eager-loading-with-preload",children:"Eager Loading with Preload"}),"\n",(0,i.jsxs)(n.p,{children:["Use ",(0,i.jsx)(n.code,{children:"Preload()"})," to load related entities in separate queries. Preloads support all relationship types: HasOne, HasMany, BelongsTo, and ManyToMany."]}),"\n",(0,i.jsx)(o.N,{title:"main.go",language:"go",snippet:"query preload",children:a}),"\n",(0,i.jsx)(n.h3,{id:"nested-preloads",children:"Nested Preloads"}),"\n",(0,i.jsx)(n.p,{children:"Load nested relationships using dot-separated paths. Conditions on nested paths apply to the leaf relation only:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-go",children:'qb.Preload("Posts.Comments")\nqb.Preload("Posts.Comments", sqlr.Condition("body != ?", ""))\n'})}),"\n",(0,i.jsx)(n.h3,{id:"auto-preload",children:"Auto-Preload"}),"\n",(0,i.jsxs)(n.p,{children:["Add the ",(0,i.jsx)(n.code,{children:"preload"})," tag option to a relationship to automatically load it on every Read and Query \u2014 without requiring an explicit ",(0,i.jsx)(n.code,{children:"Preload()"})," call:"]}),"\n",(0,i.jsx)(o.N,{title:"main.go",language:"go",snippet:"entity auto-preload",children:a}),"\n",(0,i.jsx)(n.p,{children:"Auto-preloads are recursively discovered across nested relationships and merged with any explicit preloads (explicit preloads take precedence when both are present)."}),"\n",(0,i.jsx)(n.h3,{id:"preload-conditions",children:"Preload Conditions"}),"\n",(0,i.jsxs)(n.p,{children:["Pass conditions to ",(0,i.jsx)(n.code,{children:"Preload()"})," to filter which related entities are loaded:"]}),"\n",(0,i.jsx)(o.N,{title:"main.go",language:"go",snippet:"query preload condition",children:a}),"\n",(0,i.jsx)(n.h2,{id:"eager-loading-with-joins",children:"Eager Loading with Joins"}),"\n",(0,i.jsxs)(n.p,{children:["Use ",(0,i.jsx)(n.code,{children:"LeftJoin()"}),", ",(0,i.jsx)(n.code,{children:"InnerJoin()"}),", ",(0,i.jsx)(n.code,{children:"RightJoin()"}),", or ",(0,i.jsx)(n.code,{children:"CrossJoin()"})," to load related entities via SQL JOINs. Joins support HasOne, HasMany, and BelongsTo relationships (ManyToMany and nested paths require ",(0,i.jsx)(n.code,{children:"Preload"}),")."]}),"\n",(0,i.jsx)(n.h3,{id:"joins-on-query",children:"Joins on Query"}),"\n",(0,i.jsx)(o.N,{title:"main.go",language:"go",snippet:"query join",children:a}),"\n",(0,i.jsx)(n.h3,{id:"joins-on-read",children:"Joins on Read"}),"\n",(0,i.jsxs)(n.p,{children:["Joins can also be used with ",(0,i.jsx)(n.code,{children:"Read()"})," to load relations alongside a single entity lookup:"]}),"\n",(0,i.jsx)(o.N,{title:"main.go",language:"go",snippet:"read with join",children:a}),"\n",(0,i.jsx)(n.h3,{id:"join-conditions",children:"Join Conditions"}),"\n",(0,i.jsx)(n.p,{children:"Pass conditions to restrict the joined rows:"}),"\n",(0,i.jsx)(o.N,{title:"main.go",language:"go",snippet:"query join condition",children:a}),"\n",(0,i.jsx)(n.h2,{id:"error-handling",children:"Error Handling"}),"\n",(0,i.jsxs)(n.p,{children:["The ",(0,i.jsx)(n.code,{children:"sqlr.ErrNotFound"})," sentinel error is returned when ",(0,i.jsx)(n.code,{children:"Read()"})," or ",(0,i.jsx)(n.code,{children:"Delete()"})," cannot find the requested entity:"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-go",children:"author, err := repo.Read(ctx, id)\nif errors.Is(err, sqlr.ErrNotFound) {\n    // entity does not exist\n}\n"})})]})}function u(e={}){let{wrapper:n}={...(0,s.R)(),...e.components};return n?(0,i.jsx)(n,{...e,children:(0,i.jsx)(p,{...e})}):p(e)}},4490(e,n,t){t.d(n,{N:()=>m,v:()=>f});var r=t(4848);t(6540);var i=t(5875),s=t(1083),o=t(3773),a=t(5681),d=t(8055),l=t(6311),c=t(7625),h=t(5638),p=t(6645),u=t(1113),x=t(6582),g=t(7312),j=t(3941),y=t(6497);function f(){let{colorMode:e}=(0,j.G)(),n=(0,x.A)({palette:{mode:"dark"===e?"dark":"light"}});return(0,r.jsx)(g.A,{theme:n,children:(0,r.jsxs)(h.Ay,{container:!0,spacing:4,children:[(0,r.jsx)(h.Ay,{item:!0,xs:12,s:12,md:4,children:(0,r.jsxs)(i.A,{style:{height:"100%"},children:[(0,r.jsx)(o.A,{title:"HTTP Server",avatar:(0,r.jsx)(p.default,{}),titleTypographyProps:{variant:"h6"}}),(0,r.jsx)(a.A,{children:"Build REST web services with HTTP handling, caching, OAuth, and much more."}),(0,r.jsx)(s.A,{children:(0,r.jsx)(d.A,{size:"small",href:(0,y.Ay)("/category/http-server"),children:"Get started"})})]})}),(0,r.jsx)(h.Ay,{item:!0,xs:12,md:4,children:(0,r.jsxs)(i.A,{style:{height:"100%"},children:[(0,r.jsx)(o.A,{title:"Message Queues",avatar:(0,r.jsx)(l.default,{}),titleTypographyProps:{variant:"h6"}}),(0,r.jsx)(a.A,{children:"Process asynchronous messages from Kafka, Redis, or any other queuing or streaming system."}),(0,r.jsx)(s.A,{children:(0,r.jsx)(d.A,{size:"small",href:(0,y.Ay)("/quickstart/create-a-consumer"),children:"Get started"})})]})}),(0,r.jsx)(h.Ay,{item:!0,xs:12,md:4,children:(0,r.jsxs)(i.A,{style:{height:"100%"},children:[(0,r.jsx)(o.A,{title:"Kernel Module",avatar:(0,r.jsx)(c.default,{}),titleTypographyProps:{variant:"h6"}}),(0,r.jsx)(a.A,{children:"Implement a kernel module with which you can do anything, using gosoline's logging, configuration, and other solutions."}),(0,r.jsx)(s.A,{children:(0,r.jsx)(d.A,{size:"small",href:(0,y.Ay)("/quickstart/create-an-application"),children:"Get started"})})]})})]})})}function m({children:e,snippet:n,...t}){let i=e.replace(/\n$/,"");if(n){let e=RegExp(`(?://|#) snippet-start: ${n}s*
(.*)(?://|#) snippet-end: ${n}s*$`,"sm"),t=i.match(e);t&&(i=t[1])}for(i=i.split("\n").filter(function(e){return!RegExp("w*?(?://|#) snippet.*\n*?$","g").test(e)});i.length>0&&""===i[0].trim();)i=i.slice(1);for(;i.length>0&&""===i[i.length-1].trim();)i=i.slice(0,-1);let s=(i=(i=i.join("\n")).replace(/^\t+/gm,e=>"  ".repeat(e.length))).split("\n"),o=s.filter(e=>e.trim().length>0).reduce((e,n)=>Math.min(e,n.match(/^(\s*)/)[1].length),1/0);return o>0&&o!==1/0&&(i=s.map(e=>e.slice(o)).join("\n")),(0,r.jsx)(u.A,{...t,children:i})}}}]);