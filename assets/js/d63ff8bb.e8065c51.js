"use strict";(self.webpackChunkgosoline_docs=self.webpackChunkgosoline_docs||[]).push([["9901"],{785(e,n,t){t.r(n),t.d(n,{metadata:()=>r,default:()=>x,frontMatter:()=>a,contentTitle:()=>c,toc:()=>p,assets:()=>h});var r=JSON.parse('{"id":"how-to/databases-sql/sqlh","title":"sqlh - SQL HTTP Handlers","description":"The sqlh package exposes database entities as REST API endpoints. Built on top of sqlr and sqlc, it provides automatic CRUD handler generation, a transformer pattern for input/output mapping, and transaction middleware for wrapping HTTP requests in database transactions.","source":"@site/docs/how-to/databases-sql/sqlh.mdx","sourceDirName":"how-to/databases-sql","slug":"/how-to/databases-sql/sqlh","permalink":"/docs/how-to/databases-sql/sqlh","draft":false,"unlisted":false,"editUrl":"https://github.com/gosoline-project/docs/tree/main/docs/how-to/databases-sql/sqlh.mdx","tags":[],"version":"current","sidebarPosition":3,"frontMatter":{"sidebar_position":3,"title":"sqlh - SQL HTTP Handlers"},"sidebar":"docSidebar","previous":{"title":"sqlr - SQL Repository","permalink":"/docs/how-to/databases-sql/sqlr"},"next":{"title":"Notes on general Kafka usage","permalink":"/docs/how-to/kafka/general"}}'),i=t(4848),s=t(8453),d=t(4490);let o='package main\n\nimport (\n	"context"\n	_ "embed"\n	"time"\n\n	"github.com/gosoline-project/httpserver"\n	"github.com/gosoline-project/sqlh"\n	"github.com/gosoline-project/sqlr"\n	"github.com/justtrackio/gosoline/pkg/application"\n	"github.com/justtrackio/gosoline/pkg/cfg"\n	"github.com/justtrackio/gosoline/pkg/log"\n)\n\n// snippet-start: entities\ntype Author struct {\n	sqlr.Entity[int64]\n	Name  string `db:"name"`\n	Email string `db:"email"`\n}\n\n// snippet-end: entities\n\n// snippet-start: input output\ntype AuthorCreateInput struct {\n	Name  string `json:"name" binding:"required"`\n	Email string `json:"email" binding:"required"`\n}\n\ntype AuthorUpdateInput struct {\n	Name string `json:"name" binding:"required"`\n}\n\ntype AuthorOutput struct {\n	Id        int64     `json:"id"`\n	Name      string    `json:"name"`\n	Email     string    `json:"email"`\n	CreatedAt time.Time `json:"created_at"`\n	UpdatedAt time.Time `json:"updated_at"`\n}\n\n// snippet-end: input output\n\n// snippet-start: transformer\ntype AuthorTransformer struct{}\n\nfunc (t *AuthorTransformer) TransformCreate(_ context.Context, input *AuthorCreateInput) (*Author, error) {\n	return &Author{\n		Name:  input.Name,\n		Email: input.Email,\n	}, nil\n}\n\nfunc (t *AuthorTransformer) TransformUpdate(_ context.Context, entity *Author, input *AuthorUpdateInput) (*Author, error) {\n	entity.Name = input.Name\n\n	return entity, nil\n}\n\nfunc (t *AuthorTransformer) TransformOutput(_ context.Context, entity *Author) (*AuthorOutput, error) {\n	return &AuthorOutput{\n		Id:        entity.Id,\n		Name:      entity.Name,\n		Email:     entity.Email,\n		CreatedAt: entity.CreatedAt,\n		UpdatedAt: entity.UpdatedAt,\n	}, nil\n}\n\n// snippet-end: transformer\n\n// snippet-start: crud handlers\nfunc NewAuthorCrud() httpserver.RegisterFactoryFunc {\n	return sqlh.WithCrudHandlers[int64, Author, AuthorCreateInput, AuthorUpdateInput, AuthorOutput](\n		1,\n		"author",\n		sqlh.SimpleTransformer[int64, Author, AuthorCreateInput, AuthorUpdateInput, AuthorOutput](\n			&AuthorTransformer{},\n		),\n	)\n}\n\n// snippet-end: crud handlers\n\n//go:embed config.dist.yml\nvar config []byte\n\n// snippet-start: main\nfunc main() {\n	application.New(\n		application.WithConfigBytes(config, "yml"),\n		application.WithLoggerHandlersFromConfig,\n		application.WithModuleFactory("http", httpserver.NewServer(\n			"default",\n			func(ctx context.Context, config cfg.Config, logger log.Logger, router *httpserver.Router) error {\n				router.HandleWith(NewAuthorCrud())\n\n				return nil\n			},\n		)),\n	).Run()\n}\n\n// snippet-end: main\n',l='package main\n\nimport (\n	"context"\n	_ "embed"\n	"fmt"\n	"time"\n\n	"github.com/gosoline-project/httpserver"\n	"github.com/gosoline-project/sqlc"\n	"github.com/gosoline-project/sqlh"\n	"github.com/gosoline-project/sqlr"\n	"github.com/justtrackio/gosoline/pkg/application"\n	"github.com/justtrackio/gosoline/pkg/cfg"\n	"github.com/justtrackio/gosoline/pkg/log"\n)\n\n// snippet-start: post entities\ntype Post struct {\n	sqlr.Entity[int64]\n	AuthorID int64  `db:"author_id"`\n	Title    string `db:"title"`\n	Body     string `db:"body"`\n	Status   string `db:"status"`\n}\n\ntype PostCreateInput struct {\n	Title string `json:"title" binding:"required"`\n	Body  string `json:"body" binding:"required"`\n}\n\ntype PostOutput struct {\n	Id        int64     `json:"id"`\n	AuthorID  int64     `json:"author_id"`\n	Title     string    `json:"title"`\n	Body      string    `json:"body"`\n	Status    string    `json:"status"`\n	CreatedAt time.Time `json:"created_at"`\n}\n\n// snippet-end: post entities\n\n// snippet-start: with tx handler\ntype PostHandler struct {\n}\n\nfunc NewPostHandler() httpserver.HandlerFactory[PostHandler] {\n	return func(ctx context.Context, config cfg.Config, logger log.Logger) (*PostHandler, error) {\n		return &PostHandler{}, nil\n	}\n}\n\n// snippet-end: with tx handler\n\n// snippet-start: bind tx handler\nfunc (h *PostHandler) HandleCreatePost(cttx sqlc.Tx, input *PostCreateInput) (httpserver.Response, error) {\n	// The transaction is automatically managed \u2014 commit on success, rollback on error.\n	// Use cttx.Q() to execute queries within the transaction scope.\n\n	post := &Post{\n		Title:  input.Title,\n		Body:   input.Body,\n		Status: "draft",\n	}\n\n	_, err := cttx.Q().Into("posts").Records(post).Exec(cttx)\n	if err != nil {\n		return nil, fmt.Errorf("failed to create post: %w", err)\n	}\n\n	return httpserver.NewJsonResponse(post), nil\n}\n\n// snippet-end: bind tx handler\n\n// snippet-start: bind tx no input\nfunc (h *PostHandler) HandleReadPost(cttx sqlc.Tx) (httpserver.Response, error) {\n	// BindTxN is used when no request body input is needed.\n	// The transaction is still available for database operations.\n\n	var posts []Post\n	err := cttx.Q().From("posts").Where(sqlc.Col("status").Eq("draft")).Select(cttx, &posts)\n	if err != nil {\n		return nil, fmt.Errorf("failed to query posts: %w", err)\n	}\n\n	return httpserver.NewJsonResponse(posts), nil\n}\n\n// snippet-end: bind tx no input\n\n//go:embed config.dist.yml\nvar config []byte\n\n// snippet-start: main\nfunc main() {\n	application.New(\n		application.WithConfigBytes(config, "yml"),\n		application.WithLoggerHandlersFromConfig,\n		application.WithModuleFactory("http", httpserver.NewServer(\n			"default",\n			// snippet-start: with tx register\n			func(ctx context.Context, config cfg.Config, logger log.Logger, router *httpserver.Router) error {\n				router.HandleWith(sqlh.WithTx(NewPostHandler(), func(router *httpserver.Router, handler *PostHandler) {\n					router.POST("/v1/authors/:id/posts", sqlh.BindTx(handler.HandleCreatePost))\n					router.GET("/v1/posts/:id", sqlh.BindTxN(handler.HandleReadPost))\n				}))\n\n				return nil\n			},\n			// snippet-end: with tx register\n		)),\n	).Run()\n}\n\n// snippet-end: main\n',a={sidebar_position:3,title:"sqlh - SQL HTTP Handlers"},c,h={},p=[{value:"Getting Started",id:"getting-started",level:2},{value:"Configuration",id:"configuration",level:2},{value:"CRUD Handlers",id:"crud-handlers",level:2},{value:"Defining Entities",id:"defining-entities",level:3},{value:"Input and Output Types",id:"input-and-output-types",level:3},{value:"Implementing the Transformer",id:"implementing-the-transformer",level:3},{value:"TransformerOutput (Optional)",id:"transformeroutput-optional",level:4},{value:"SimpleTransformer Helper",id:"simpletransformer-helper",level:4},{value:"Registering CRUD Handlers",id:"registering-crud-handlers",level:3},{value:"Generated Endpoints",id:"generated-endpoints",level:3},{value:"Query with JSON Filter",id:"query-with-json-filter",level:3},{value:"Wiring into the Application",id:"wiring-into-the-application",level:3},{value:"Transaction Middleware",id:"transaction-middleware",level:2},{value:"Setting Up WithTx",id:"setting-up-withtx",level:3},{value:"Transaction Binding Helpers",id:"transaction-binding-helpers",level:3},{value:"BindTx \u2014 With Input",id:"bindtx--with-input",level:4},{value:"BindTxN \u2014 No Input",id:"bindtxn--no-input",level:4},{value:"BindTxR / BindTxNR \u2014 With Raw Request",id:"bindtxr--bindtxnr--with-raw-request",level:4},{value:"Wiring into the Application",id:"wiring-into-the-application-1",level:3},{value:"Summary of Binding Functions",id:"summary-of-binding-functions",level:3}];function u(e){let n={a:"a",code:"code",h2:"h2",h3:"h3",h4:"h4",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,s.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsxs)(n.p,{children:["The ",(0,i.jsx)(n.code,{children:"sqlh"})," package exposes database entities as REST API endpoints. Built on top of ",(0,i.jsx)(n.a,{href:"/docs/how-to/databases-sql/sqlr",children:(0,i.jsx)(n.code,{children:"sqlr"})})," and ",(0,i.jsx)(n.a,{href:"/docs/how-to/databases-sql/sqlc",children:(0,i.jsx)(n.code,{children:"sqlc"})}),", it provides automatic CRUD handler generation, a transformer pattern for input/output mapping, and transaction middleware for wrapping HTTP requests in database transactions."]}),"\n",(0,i.jsx)(n.h2,{id:"getting-started",children:"Getting Started"}),"\n",(0,i.jsx)(n.p,{children:"Add the dependency to your Go module:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"go get github.com/gosoline-project/sqlh@v0.1.0\n"})}),"\n",(0,i.jsx)(n.p,{children:"Then import the package in your Go code:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-go",children:'import "github.com/gosoline-project/sqlh"\n'})}),"\n",(0,i.jsx)(n.h2,{id:"configuration",children:"Configuration"}),"\n",(0,i.jsxs)(n.p,{children:["The ",(0,i.jsx)(n.code,{children:"sqlh"})," package requires both an HTTP server and a database client. Configure them under the ",(0,i.jsx)(n.code,{children:"httpserver"})," and ",(0,i.jsx)(n.code,{children:"sqlc"})," keys respectively:"]}),"\n",(0,i.jsx)(d.N,{title:"config.dist.yml",language:"yaml",snippet:"config",children:"env: dev\n\napp_project: gosoline\napp_family: docs\napp_group: database-sql\napp_name: sqlh-crud\n\nlog:\n  handlers:\n    main:\n      level: debug\n\n# snippet-start: config\nhttpserver:\n  default:\n    port: 8080\n    mode: release\n\nsqlc:\n  default:\n    driver: mysql\n    uri:\n      host: 127.0.0.1\n      port: 3306\n      user: root\n      password: gosoline\n      database: blog\n    migrations:\n      enabled: true\n      reset: true\n      path: migrations\n# snippet-end: config\n"}),"\n",(0,i.jsxs)(n.p,{children:["The HTTP server configuration is described in the httpserver documentation. The database configuration follows the same format described in the ",(0,i.jsx)(n.a,{href:"/docs/how-to/databases-sql/sqlc#configuration",children:"sqlc documentation"}),"."]}),"\n",(0,i.jsx)(n.h2,{id:"crud-handlers",children:"CRUD Handlers"}),"\n",(0,i.jsxs)(n.p,{children:["The ",(0,i.jsx)(n.code,{children:"WithCrudHandlers"})," function generates a complete set of REST endpoints for an entity. It connects an ",(0,i.jsx)(n.code,{children:"sqlr"})," repository with a transformer to handle input/output mapping."]}),"\n",(0,i.jsx)(n.h3,{id:"defining-entities",children:"Defining Entities"}),"\n",(0,i.jsxs)(n.p,{children:["Entities use the same ",(0,i.jsx)(n.code,{children:"sqlr.Entity"})," base struct described in the ",(0,i.jsx)(n.a,{href:"/docs/how-to/databases-sql/sqlr#defining-entities",children:"sqlr documentation"}),":"]}),"\n",(0,i.jsx)(d.N,{title:"main.go",language:"go",snippet:"entities",children:o}),"\n",(0,i.jsx)(n.h3,{id:"input-and-output-types",children:"Input and Output Types"}),"\n",(0,i.jsx)(n.p,{children:"Define separate types for create input, update input, and API output. These decouple the HTTP API from the database entity:"}),"\n",(0,i.jsx)(d.N,{title:"main.go",language:"go",snippet:"input output",children:o}),"\n",(0,i.jsx)(n.p,{children:"Using separate types lets you:"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["Validate input with ",(0,i.jsx)(n.code,{children:"binding"})," tags (e.g., ",(0,i.jsx)(n.code,{children:'binding:"required"'}),")"]}),"\n",(0,i.jsxs)(n.li,{children:["Exclude internal fields (like ",(0,i.jsx)(n.code,{children:"Id"})," or ",(0,i.jsx)(n.code,{children:"CreatedAt"}),") from create/update input"]}),"\n",(0,i.jsx)(n.li,{children:"Shape the API response independently from the database schema"}),"\n"]}),"\n",(0,i.jsx)(n.h3,{id:"implementing-the-transformer",children:"Implementing the Transformer"}),"\n",(0,i.jsxs)(n.p,{children:["The ",(0,i.jsx)(n.code,{children:"Transformer[K, E, IC, IU, O]"})," interface converts between input types and entity types. Implement ",(0,i.jsx)(n.code,{children:"TransformCreate"})," and ",(0,i.jsx)(n.code,{children:"TransformUpdate"}),":"]}),"\n",(0,i.jsx)(d.N,{title:"main.go",language:"go",snippet:"transformer",children:o}),"\n",(0,i.jsx)(n.p,{children:"The type parameters are:"}),"\n",(0,i.jsxs)(n.table,{children:[(0,i.jsx)(n.thead,{children:(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.th,{children:"Parameter"}),(0,i.jsx)(n.th,{children:"Description"})]})}),(0,i.jsxs)(n.tbody,{children:[(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"K"})}),(0,i.jsxs)(n.td,{children:["Primary key type (e.g., ",(0,i.jsx)(n.code,{children:"int64"}),")"]})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"E"})}),(0,i.jsxs)(n.td,{children:["Entity type (e.g., ",(0,i.jsx)(n.code,{children:"Author"}),")"]})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"IC"})}),(0,i.jsxs)(n.td,{children:["Create input type (e.g., ",(0,i.jsx)(n.code,{children:"AuthorCreateInput"}),")"]})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"IU"})}),(0,i.jsxs)(n.td,{children:["Update input type (e.g., ",(0,i.jsx)(n.code,{children:"AuthorUpdateInput"}),")"]})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"O"})}),(0,i.jsxs)(n.td,{children:["Output type (e.g., ",(0,i.jsx)(n.code,{children:"AuthorOutput"}),")"]})]})]})]}),"\n",(0,i.jsx)(n.h4,{id:"transformeroutput-optional",children:"TransformerOutput (Optional)"}),"\n",(0,i.jsxs)(n.p,{children:["If the transformer also implements ",(0,i.jsx)(n.code,{children:"TransformerOutput[K, E, O]"}),", the output is transformed before being returned as JSON. If not implemented, the raw entity is returned directly:"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-go",children:"type TransformerOutput[K sqlr.KeyTypes, E sqlr.Entitier[K], O any] interface {\n    TransformOutput(ctx context.Context, entity *E) (*O, error)\n}\n"})}),"\n",(0,i.jsxs)(n.p,{children:["In the example above, ",(0,i.jsx)(n.code,{children:"AuthorTransformer"})," implements both ",(0,i.jsx)(n.code,{children:"Transformer"})," and ",(0,i.jsx)(n.code,{children:"TransformerOutput"}),", so API responses use the ",(0,i.jsx)(n.code,{children:"AuthorOutput"})," shape."]}),"\n",(0,i.jsx)(n.h4,{id:"simpletransformer-helper",children:"SimpleTransformer Helper"}),"\n",(0,i.jsxs)(n.p,{children:["Use ",(0,i.jsx)(n.code,{children:"sqlh.SimpleTransformer()"})," when your transformer has no dependencies and doesn't need access to ",(0,i.jsx)(n.code,{children:"config"})," or ",(0,i.jsx)(n.code,{children:"logger"})," during construction:"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-go",children:"sqlh.SimpleTransformer[K, E, IC, IU, O](&MyTransformer{})\n"})}),"\n",(0,i.jsxs)(n.p,{children:["For transformers that need dependencies, implement ",(0,i.jsx)(n.code,{children:"TransformerFactory"})," directly:"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-go",children:"type TransformerFactory[K, E, IC, IU, O] func(ctx context.Context, config cfg.Config, logger log.Logger) (Transformer[K, E, IC, IU, O], error)\n"})}),"\n",(0,i.jsx)(n.h3,{id:"registering-crud-handlers",children:"Registering CRUD Handlers"}),"\n",(0,i.jsxs)(n.p,{children:["Use ",(0,i.jsx)(n.code,{children:"WithCrudHandlers"})," to generate all endpoints and register them with the HTTP server:"]}),"\n",(0,i.jsx)(d.N,{title:"main.go",language:"go",snippet:"crud handlers",children:o}),"\n",(0,i.jsx)(n.p,{children:"The arguments are:"}),"\n",(0,i.jsxs)(n.table,{children:[(0,i.jsx)(n.thead,{children:(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.th,{children:"Argument"}),(0,i.jsx)(n.th,{children:"Description"})]})}),(0,i.jsxs)(n.tbody,{children:[(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"version"})}),(0,i.jsxs)(n.td,{children:["API version number, used in the URL path (e.g., ",(0,i.jsx)(n.code,{children:"1"})," produces ",(0,i.jsx)(n.code,{children:"/v1/..."}),")"]})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"entityName"})}),(0,i.jsxs)(n.td,{children:["Singular entity name for the URL path (e.g., ",(0,i.jsx)(n.code,{children:'"author"'}),")"]})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"transformerFactory"})}),(0,i.jsx)(n.td,{children:"Factory that creates the transformer instance"})]})]})]}),"\n",(0,i.jsx)(n.h3,{id:"generated-endpoints",children:"Generated Endpoints"}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.code,{children:"WithCrudHandlers"})," registers five endpoints:"]}),"\n",(0,i.jsxs)(n.table,{children:[(0,i.jsx)(n.thead,{children:(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.th,{children:"Method"}),(0,i.jsx)(n.th,{children:"Path"}),(0,i.jsx)(n.th,{children:"Handler"}),(0,i.jsx)(n.th,{children:"Description"})]})}),(0,i.jsxs)(n.tbody,{children:[(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"POST"})}),(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"/v{n}/{entity}"})}),(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"HandleCreate"})}),(0,i.jsxs)(n.td,{children:["Creates an entity from ",(0,i.jsx)(n.code,{children:"IC"})," input"]})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"GET"})}),(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"/v{n}/{entity}/:id"})}),(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"HandleRead"})}),(0,i.jsx)(n.td,{children:"Reads a single entity by ID"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"PUT"})}),(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"/v{n}/{entity}/:id"})}),(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"HandleUpdate"})}),(0,i.jsxs)(n.td,{children:["Updates an entity from ",(0,i.jsx)(n.code,{children:"IU"})," input"]})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"DELETE"})}),(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"/v{n}/{entity}/:id"})}),(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"HandleDelete"})}),(0,i.jsx)(n.td,{children:"Deletes an entity by ID"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"POST"})}),(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"/v{n}/{entities}"})}),(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"HandleQuery"})}),(0,i.jsx)(n.td,{children:"Queries entities with a JSON filter"})]})]})]}),"\n",(0,i.jsxs)(n.p,{children:["The query endpoint uses the ",(0,i.jsx)(n.strong,{children:"plural"})," form of the entity name (e.g., ",(0,i.jsx)(n.code,{children:'"author"'})," becomes ",(0,i.jsx)(n.code,{children:'"/v1/authors"'}),"). Pluralization is handled automatically."]}),"\n",(0,i.jsx)(n.h3,{id:"query-with-json-filter",children:"Query with JSON Filter"}),"\n",(0,i.jsxs)(n.p,{children:["The query endpoint accepts a JSON body with a ",(0,i.jsx)(n.code,{children:"filter"})," field that maps to ",(0,i.jsx)(n.code,{children:"sqlc.JsonFilter"}),":"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-json",children:'{\n  "filter": {\n    "column": "name",\n    "operator": "=",\n    "value": "Alice"\n  }\n}\n'})}),"\n",(0,i.jsxs)(n.p,{children:["The filter is converted to an ",(0,i.jsx)(n.code,{children:"sqlc.Expression"})," and applied as a WHERE condition on the query. See the ",(0,i.jsx)(n.a,{href:"/docs/how-to/databases-sql/sqlc",children:"sqlc JSON filter documentation"})," for the full filter syntax."]}),"\n",(0,i.jsx)(n.h3,{id:"wiring-into-the-application",children:"Wiring into the Application"}),"\n",(0,i.jsxs)(n.p,{children:["Register handlers with the gosoline HTTP server using ",(0,i.jsx)(n.code,{children:"router.HandleWith()"}),":"]}),"\n",(0,i.jsx)(d.N,{title:"main.go",language:"go",snippet:"main",children:o}),"\n",(0,i.jsx)(n.h2,{id:"transaction-middleware",children:"Transaction Middleware"}),"\n",(0,i.jsxs)(n.p,{children:["The ",(0,i.jsx)(n.code,{children:"WithTx"})," function wraps a group of HTTP routes in a database transaction. Each request automatically begins a transaction before the handler runs, commits on success, and rolls back if any error occurs."]}),"\n",(0,i.jsx)(n.h3,{id:"setting-up-withtx",children:"Setting Up WithTx"}),"\n",(0,i.jsxs)(n.p,{children:["Create a handler struct with a factory function, then use ",(0,i.jsx)(n.code,{children:"WithTx"})," to register routes:"]}),"\n",(0,i.jsx)(d.N,{title:"main.go",language:"go",snippet:"with tx handler",children:l}),"\n",(0,i.jsx)(d.N,{title:"main.go",language:"go",snippet:"with tx register",children:l}),"\n",(0,i.jsxs)(n.p,{children:["Notice that the handler struct does not create or hold a repository. Instead of manually setting up database access, each handler receives an active ",(0,i.jsx)(n.code,{children:"sqlc.Tx"})," directly through the ",(0,i.jsx)(n.code,{children:"Bind*"})," helpers \u2014 the transaction is started automatically before the handler runs and committed or rolled back afterward."]}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.code,{children:"WithTx"})," takes two arguments:"]}),"\n",(0,i.jsxs)(n.table,{children:[(0,i.jsx)(n.thead,{children:(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.th,{children:"Argument"}),(0,i.jsx)(n.th,{children:"Description"})]})}),(0,i.jsxs)(n.tbody,{children:[(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"handlerFactory"})}),(0,i.jsxs)(n.td,{children:["Factory that creates the handler struct (with access to ",(0,i.jsx)(n.code,{children:"config"})," and ",(0,i.jsx)(n.code,{children:"logger"}),")"]})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"register"})}),(0,i.jsx)(n.td,{children:"Function that registers routes on the router, receiving the handler instance"})]})]})]}),"\n",(0,i.jsx)(n.p,{children:"The middleware:"}),"\n",(0,i.jsxs)(n.ol,{children:["\n",(0,i.jsxs)(n.li,{children:["Begins a transaction via ",(0,i.jsx)(n.code,{children:"sqlClient.BeginTx()"})," before each request"]}),"\n",(0,i.jsx)(n.li,{children:"Stores the transaction in the gin context"}),"\n",(0,i.jsx)(n.li,{children:"Calls the next handler"}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Commits"})," if no errors occurred"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Rolls back"})," if any handler in the chain added an error to the gin context"]}),"\n"]}),"\n",(0,i.jsx)(n.h3,{id:"transaction-binding-helpers",children:"Transaction Binding Helpers"}),"\n",(0,i.jsxs)(n.p,{children:["Inside a ",(0,i.jsx)(n.code,{children:"WithTx"}),"-wrapped route group, use the ",(0,i.jsx)(n.code,{children:"BindTx"})," family of functions to extract the transaction and bind request input:"]}),"\n",(0,i.jsx)(n.h4,{id:"bindtx--with-input",children:"BindTx \u2014 With Input"}),"\n",(0,i.jsxs)(n.p,{children:["Use ",(0,i.jsx)(n.code,{children:"BindTx"})," when the handler needs both the transaction and a parsed request body:"]}),"\n",(0,i.jsx)(d.N,{title:"main.go",language:"go",snippet:"bind tx handler",children:l}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.code,{children:"BindTx"})," automatically:"]}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["Binds the request body to the input type ",(0,i.jsx)(n.code,{children:"I"})]}),"\n",(0,i.jsxs)(n.li,{children:["Extracts the ",(0,i.jsx)(n.code,{children:"sqlc.Tx"})," from the gin context"]}),"\n",(0,i.jsx)(n.li,{children:"Calls the handler with both"}),"\n",(0,i.jsx)(n.li,{children:"Writes the response"}),"\n"]}),"\n",(0,i.jsx)(n.h4,{id:"bindtxn--no-input",children:"BindTxN \u2014 No Input"}),"\n",(0,i.jsxs)(n.p,{children:["Use ",(0,i.jsx)(n.code,{children:"BindTxN"})," when the handler only needs the transaction (no request body):"]}),"\n",(0,i.jsx)(d.N,{title:"main.go",language:"go",snippet:"bind tx no input",children:l}),"\n",(0,i.jsxs)(n.p,{children:["Since ",(0,i.jsx)(n.code,{children:"sqlc.Tx"})," implements ",(0,i.jsx)(n.code,{children:"Querier"}),", you can pass it to ",(0,i.jsx)(n.code,{children:"WithClient()"})," on query builders to execute queries within the transaction."]}),"\n",(0,i.jsx)(n.h4,{id:"bindtxr--bindtxnr--with-raw-request",children:"BindTxR / BindTxNR \u2014 With Raw Request"}),"\n",(0,i.jsxs)(n.p,{children:["For handlers that need access to the raw ",(0,i.jsx)(n.code,{children:"*http.Request"})," (e.g., to read headers or query parameters), use the ",(0,i.jsx)(n.code,{children:"R"})," variants:"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-go",children:'// With input + raw request\nsqlh.BindTxR(func(cttx sqlc.Tx, req *http.Request, input *MyInput) (httpserver.Response, error) {\n    userAgent := req.Header.Get("User-Agent")\n    // ...\n})\n\n// No input + raw request\nsqlh.BindTxNR(func(cttx sqlc.Tx, req *http.Request) (httpserver.Response, error) {\n    // ...\n})\n'})}),"\n",(0,i.jsx)(n.h3,{id:"wiring-into-the-application-1",children:"Wiring into the Application"}),"\n",(0,i.jsx)(d.N,{title:"main.go",language:"go",snippet:"main",children:l}),"\n",(0,i.jsx)(n.h3,{id:"summary-of-binding-functions",children:"Summary of Binding Functions"}),"\n",(0,i.jsxs)(n.table,{children:[(0,i.jsx)(n.thead,{children:(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.th,{children:"Function"}),(0,i.jsx)(n.th,{children:"Input"}),(0,i.jsx)(n.th,{children:"Raw Request"}),(0,i.jsx)(n.th,{children:"Signature"})]})}),(0,i.jsxs)(n.tbody,{children:[(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"BindTx"})}),(0,i.jsx)(n.td,{children:"Yes"}),(0,i.jsx)(n.td,{children:"No"}),(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"func(cttx sqlc.Tx, input *I) (Response, error)"})})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"BindTxR"})}),(0,i.jsx)(n.td,{children:"Yes"}),(0,i.jsx)(n.td,{children:"Yes"}),(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"func(cttx sqlc.Tx, req *http.Request, input *I) (Response, error)"})})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"BindTxN"})}),(0,i.jsx)(n.td,{children:"No"}),(0,i.jsx)(n.td,{children:"No"}),(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"func(cttx sqlc.Tx) (Response, error)"})})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"BindTxNR"})}),(0,i.jsx)(n.td,{children:"No"}),(0,i.jsx)(n.td,{children:"Yes"}),(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"func(cttx sqlc.Tx, req *http.Request) (Response, error)"})})]})]})]})]})}function x(e={}){let{wrapper:n}={...(0,s.R)(),...e.components};return n?(0,i.jsx)(n,{...e,children:(0,i.jsx)(u,{...e})}):u(e)}},4490(e,n,t){t.d(n,{N:()=>y,v:()=>f});var r=t(4848);t(6540);var i=t(5875),s=t(1083),d=t(3773),o=t(5681),l=t(8055),a=t(6311),c=t(7625),h=t(5638),p=t(6645),u=t(1113),x=t(6582),j=t(7312),g=t(3941),m=t(6497);function f(){let{colorMode:e}=(0,g.G)(),n=(0,x.A)({palette:{mode:"dark"===e?"dark":"light"}});return(0,r.jsx)(j.A,{theme:n,children:(0,r.jsxs)(h.Ay,{container:!0,spacing:4,children:[(0,r.jsx)(h.Ay,{item:!0,xs:12,s:12,md:4,children:(0,r.jsxs)(i.A,{style:{height:"100%"},children:[(0,r.jsx)(d.A,{title:"HTTP Server",avatar:(0,r.jsx)(p.default,{}),titleTypographyProps:{variant:"h6"}}),(0,r.jsx)(o.A,{children:"Build REST web services with HTTP handling, caching, OAuth, and much more."}),(0,r.jsx)(s.A,{children:(0,r.jsx)(l.A,{size:"small",href:(0,m.Ay)("/category/http-server"),children:"Get started"})})]})}),(0,r.jsx)(h.Ay,{item:!0,xs:12,md:4,children:(0,r.jsxs)(i.A,{style:{height:"100%"},children:[(0,r.jsx)(d.A,{title:"Message Queues",avatar:(0,r.jsx)(a.default,{}),titleTypographyProps:{variant:"h6"}}),(0,r.jsx)(o.A,{children:"Process asynchronous messages from Kafka, Redis, or any other queuing or streaming system."}),(0,r.jsx)(s.A,{children:(0,r.jsx)(l.A,{size:"small",href:(0,m.Ay)("/quickstart/create-a-consumer"),children:"Get started"})})]})}),(0,r.jsx)(h.Ay,{item:!0,xs:12,md:4,children:(0,r.jsxs)(i.A,{style:{height:"100%"},children:[(0,r.jsx)(d.A,{title:"Kernel Module",avatar:(0,r.jsx)(c.default,{}),titleTypographyProps:{variant:"h6"}}),(0,r.jsx)(o.A,{children:"Implement a kernel module with which you can do anything, using gosoline's logging, configuration, and other solutions."}),(0,r.jsx)(s.A,{children:(0,r.jsx)(l.A,{size:"small",href:(0,m.Ay)("/quickstart/create-an-application"),children:"Get started"})})]})})]})})}function y({children:e,snippet:n,...t}){let i=e.replace(/\n$/,"");if(n){let e=RegExp(`(?://|#) snippet-start: ${n}s*
(.*)(?://|#) snippet-end: ${n}s*$`,"sm"),t=i.match(e);t&&(i=t[1])}for(i=i.split("\n").filter(function(e){return!RegExp("w*?(?://|#) snippet.*\n*?$","g").test(e)});i.length>0&&""===i[0].trim();)i=i.slice(1);for(;i.length>0&&""===i[i.length-1].trim();)i=i.slice(0,-1);let s=(i=(i=i.join("\n")).replace(/^\t+/gm,e=>"  ".repeat(e.length))).split("\n"),d=s.filter(e=>e.trim().length>0).reduce((e,n)=>Math.min(e,n.match(/^(\s*)/)[1].length),1/0);return d>0&&d!==1/0&&(i=s.map(e=>e.slice(d)).join("\n")),(0,r.jsx)(u.A,{...t,children:i})}}}]);