"use strict";(self.webpackChunkgosoline_docs=self.webpackChunkgosoline_docs||[]).push([["2459"],{2567(e,t,n){n.r(t),n.d(t,{metadata:()=>s,default:()=>h,frontMatter:()=>u,contentTitle:()=>c,toc:()=>d,assets:()=>a});var s=JSON.parse('{"id":"quickstart/testing/test-your-consumer","title":"Test your consumer","description":"In this tutorial, you\'ll create an integration test for a message queue consumer that reads from an input and writes to an output.","source":"@site/docs/quickstart/testing/test-your-consumer.mdx","sourceDirName":"quickstart/testing","slug":"/quickstart/testing/test-your-consumer","permalink":"/docs/quickstart/testing/test-your-consumer","draft":false,"unlisted":false,"editUrl":"https://github.com/gosoline-project/docs/tree/main/docs/quickstart/testing/test-your-consumer.mdx","tags":[],"version":"current","sidebarPosition":1,"frontMatter":{"sidebar_position":1,"title":"Test your consumer"},"sidebar":"docSidebar","previous":{"title":"Testing","permalink":"/docs/category/testing"},"next":{"title":"Test your HTTP server","permalink":"/docs/quickstart/testing/test-your-http-server"}}'),r=n(4848),i=n(8453),o=n(1113);let u={sidebar_position:1,title:"Test your consumer"},c,a={},d=[{value:"Before you begin",id:"before-you-begin",level:2},{value:"Write your integration test",id:"write-your-integration-test",level:2},{value:"Import your dependencies",id:"import-your-dependencies",level:3},{value:"Create a test suite",id:"create-a-test-suite",level:3},{value:"Create a runner",id:"create-a-runner",level:3},{value:"Set up your test suite",id:"set-up-your-test-suite",level:3},{value:"Create a test case",id:"create-a-test-case",level:3},{value:"Run your test",id:"run-your-test",level:2},{value:"Conclusion",id:"conclusion",level:2}];function l(e){let t={a:"a",code:"code",h2:"h2",h3:"h3",li:"li",ol:"ol",p:"p",pre:"pre",ul:"ul",...(0,i.R)(),...e.components},{Details:n}=t;return n||function(e,t){throw Error("Expected "+(t?"component":"object")+" `"+e+"` to be defined: you likely forgot to import, pass, or provide it.")}("Details",!0),(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(t.p,{children:"In this tutorial, you'll create an integration test for a message queue consumer that reads from an input and writes to an output."}),"\n",(0,r.jsx)(t.h2,{id:"before-you-begin",children:"Before you begin"}),"\n",(0,r.jsx)(t.p,{children:"This tutorial tests a minimal application with the following files:"}),"\n",(0,r.jsxs)(n,{children:[(0,r.jsx)("summary",{children:"config.dist.yml"}),(0,r.jsx)(o.A,{showLineNumbers:!0,language:"yaml",children:'app:\n  env: dev\n  name: consumer\n  namespace: "{app.tags.project}.{app.env}.{app.tags.family}.{app.tags.group}"\n  tags:\n    project: gosoline\n    family: how-to\n    group: grp\n\nstream:\n  input:\n    consumer:\n      type: sqs\n      target_queue_id: events\n\n  output:\n    todos:\n      type:\n        type: sqs\n        queue_id: todos\n'})]}),"\n",(0,r.jsxs)(n,{children:[(0,r.jsx)("summary",{children:"consumer.go"}),(0,r.jsx)(o.A,{showLineNumbers:!0,language:"go",title:"consumer.go",children:'package consumertest\n\nimport (\n	"context"\n	"fmt"\n\n	"github.com/justtrackio/gosoline/pkg/cfg"\n	"github.com/justtrackio/gosoline/pkg/log"\n	"github.com/justtrackio/gosoline/pkg/stream"\n)\n\ntype Todo struct {\n	Id     int\n	Text   string\n	Status string\n}\n\ntype Consumer struct {\n	producer stream.Producer\n}\n\nfunc NewConsumer(ctx context.Context, config cfg.Config, logger log.Logger) (stream.ConsumerCallback[Todo], error) {\n	var err error\n	var producer stream.Producer\n\n	if producer, err = stream.NewProducer(ctx, config, logger, "todos"); err != nil {\n		return nil, fmt.Errorf("can not create the todos producer: %w", err)\n	}\n\n	consumer := &Consumer{\n		producer: producer,\n	}\n\n	return consumer, nil\n}\n\nfunc (c Consumer) Consume(ctx context.Context, todo Todo, attributes map[string]string) (bool, error) {\n	todo.Status = "pending"\n\n	if err := c.producer.WriteOne(ctx, todo); err != nil {\n		return false, fmt.Errorf("can not write todo with id %d: %w", todo.Id, err)\n	}\n\n	return true, nil\n}\n'})]}),"\n",(0,r.jsx)(t.h2,{id:"write-your-integration-test",children:"Write your integration test"}),"\n",(0,r.jsx)(t.p,{children:"Here is a preview of all the code you'll cover in this tutorial:"}),"\n",(0,r.jsxs)(n,{children:[(0,r.jsx)("summary",{children:"consumer_test.go"}),(0,r.jsx)(o.A,{showLineNumbers:!0,language:"go",children:'package consumertest\n\nimport (\n	"testing"\n\n	"github.com/justtrackio/gosoline/pkg/stream"\n	"github.com/justtrackio/gosoline/pkg/test/suite"\n)\n\ntype ConsumerTestSuite struct {\n	suite.Suite\n}\n\nfunc TestConsumerTestSuite(t *testing.T) {\n	suite.Run(t, new(ConsumerTestSuite))\n}\n\nfunc (s *ConsumerTestSuite) SetupSuite() []suite.Option {\n	return []suite.Option{\n		suite.WithConfigFile("config.dist.yml"),\n		suite.WithConsumer(NewConsumer),\n	}\n}\n\nfunc (s *ConsumerTestSuite) TestSuccess() *suite.StreamTestCase {\n	return &suite.StreamTestCase{\n		Input: map[string][]suite.StreamTestCaseInput{\n			"consumer": {\n				{\n					Body: &Todo{\n						Id:   1,\n						Text: "do it",\n					},\n				},\n			},\n		},\n		Output: map[string][]suite.StreamTestCaseOutput{\n			"todos": {\n				{\n					Model: &Todo{},\n					ExpectedBody: &Todo{\n						Id:     1,\n						Text:   "do it",\n						Status: "pending",\n					},\n					ExpectedAttributes: map[string]string{\n						stream.AttributeEncoding: stream.EncodingJson.String(),\n					},\n				},\n			},\n		},\n		Assert: func() error {\n			msgCount := s.Env().StreamOutput("todos").Len()\n			s.Equal(1, msgCount)\n\n			return nil\n		},\n	}\n}\n'})]}),"\n",(0,r.jsx)(t.h3,{id:"import-your-dependencies",children:"Import your dependencies"}),"\n",(0,r.jsx)(t.p,{children:"First, import your dependencies:"}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{className:"language-go",children:'import (\n	"testing"\n\n	"github.com/justtrackio/gosoline/pkg/test/suite"\n)\n'})}),"\n",(0,r.jsxs)(t.p,{children:["Here, you've imported the standard ",(0,r.jsx)(t.code,{children:"testing"})," package as well as gosoline's ",(0,r.jsx)(t.code,{children:"test/suite"}),"."]}),"\n",(0,r.jsx)(t.h3,{id:"create-a-test-suite",children:"Create a test suite"}),"\n",(0,r.jsxs)(t.p,{children:["Next, create a test suite that embeds the type ",(0,r.jsx)(t.code,{children:"suite.Suite"}),":"]}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{className:"language-go",children:"type ConsumerTestSuite struct {\n	suite.Suite\n}\n"})}),"\n",(0,r.jsx)(t.h3,{id:"create-a-runner",children:"Create a runner"}),"\n",(0,r.jsx)(t.p,{children:"Then, create the main test runner which will run the suite:"}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{className:"language-go",children:"func TestConsumerTestSuite(t *testing.T) {\n	suite.Run(t, new(ConsumerTestSuite))\n}\n"})}),"\n",(0,r.jsx)(t.h3,{id:"set-up-your-test-suite",children:"Set up your test suite"}),"\n",(0,r.jsxs)(t.p,{children:["Implement ",(0,r.jsx)(t.code,{children:"SetupSuite"}),":"]}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{className:"language-go",children:'func (s *ConsumerTestSuite) SetupSuite() []suite.Option {\n	return []suite.Option{\n		// 1\n		suite.WithConfigFile("config.dist.yml"),\n\n		// 2\n		suite.WithConsumer(NewConsumer),\n	}\n}\n'})}),"\n",(0,r.jsx)(t.p,{children:"This is run at the beginning of every suite. It's required, and it provides all the options to set up the suite."}),"\n",(0,r.jsx)(t.p,{children:"Here, you:"}),"\n",(0,r.jsxs)(t.ol,{children:["\n",(0,r.jsx)(t.li,{children:"Load settings from a specified config file."}),"\n",(0,r.jsx)(t.li,{children:"Test the specified consumer."}),"\n"]}),"\n",(0,r.jsx)(t.h3,{id:"create-a-test-case",children:"Create a test case"}),"\n",(0,r.jsxs)(t.p,{children:["Create a test case. This must match the pattern ",(0,r.jsx)(t.code,{children:"TestCASE() *suite.StreamTestCase"}),", where ",(0,r.jsx)(t.code,{children:"TestCASE"})," can be any name that starts with ",(0,r.jsx)(t.code,{children:"Test"}),":"]}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{className:"language-go",children:'func (s *ConsumerTestSuite) TestSuccess() *suite.StreamTestCase {\n	// 1\n	return &suite.StreamTestCase{\n		// 2\n		Input: map[string][]suite.StreamTestCaseInput{\n            // 3\n			"consumer": {\n				{					\n					Body: &Todo{\n						Id:   1,\n						Text: "do it",\n					},\n				},\n			},\n		},\n		// 4\n		Output: map[string][]suite.StreamTestCaseOutput{\n			"todos": {\n				{					\n					Model: &Todo{},				\n					ExpectedBody: &Todo{\n						Id:     1,\n						Text:   "do it",\n						Status: "pending",\n					},					\n					ExpectedAttributes: map[string]string{},\n				},\n			},\n		},\n        // 5\n		Assert: func() error {\n			msgCount := s.Env().StreamOutput("todos").Len()\n			s.Equal(1, msgCount)\n\n			return nil\n		},\n	}\n}\n'})}),"\n",(0,r.jsx)(t.p,{children:"In your integration test case, you:"}),"\n",(0,r.jsxs)(t.ol,{children:["\n",(0,r.jsx)(t.li,{children:"Return the specification of the test case"}),"\n",(0,r.jsx)(t.li,{children:"Define the input for the consumer to use"}),"\n",(0,r.jsxs)(t.li,{children:["Define your ",(0,r.jsx)(t.code,{children:"Input"})," test data.","\n",(0,r.jsxs)(t.ul,{children:["\n",(0,r.jsx)(t.li,{children:"The top-level key is the input name. This must match the name from the configuration."}),"\n",(0,r.jsxs)(t.li,{children:["Under the input name, you define the test input stream. In this example, we're using a ",(0,r.jsx)(t.code,{children:"Todo"})," struct that's defined in our example code."]}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(t.li,{children:["Define the expected output just like you did with ",(0,r.jsx)(t.code,{children:"Input"}),"\n",(0,r.jsxs)(t.ul,{children:["\n",(0,r.jsx)(t.li,{children:"The top-level key is the output name. This must match the name from the configuration."}),"\n",(0,r.jsx)(t.li,{children:"Model is used to unmarshal the written bytes back into a struct."}),"\n",(0,r.jsxs)(t.li,{children:[(0,r.jsx)(t.code,{children:"ExpectedBody"})," is compared with the written one. It has to be a perfect match."]}),"\n",(0,r.jsxs)(t.li,{children:["If the messages also have attributes, they will be checked against ",(0,r.jsx)(t.code,{children:"ExpectedAttributes"}),"."]}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(t.li,{children:["You can also provide an ",(0,r.jsx)(t.code,{children:"Assert"})," function which is executed at the end of the test case in which everything else could be checked. Here, you can access the test environment. In this example, we get the output stream and check if there was exactly one message written."]}),"\n"]}),"\n",(0,r.jsx)(t.p,{children:":::info Technical Detail"}),"\n",(0,r.jsxs)(t.p,{children:["In the sample configuration file we provided, the IO type was ",(0,r.jsx)(t.code,{children:"sqs"}),". Even so, during the test, the type will automatically be set to ",(0,r.jsx)(t.code,{children:"inMemory"}),". This is to bypass the need for external dependencies."]}),"\n",(0,r.jsx)(t.p,{children:":::"}),"\n",(0,r.jsx)(t.h2,{id:"run-your-test",children:"Run your test"}),"\n",(0,r.jsx)(t.p,{children:"Now that you've implemented your integration test, it's time to run it:"}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{className:"language-shell",children:"go mod tidy\ngo test\n"})}),"\n",(0,r.jsx)(t.p,{children:"If your test succeeded, you will see the following response at the end of your log stream:"}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{className:"language-shell",children:"PASS\n"})}),"\n",(0,r.jsx)(t.p,{children:"If your test failed, you will see a response like this:"}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{className:"language-shell",children:'--- FAIL: TestConsumerTestSuite (0.00s)\n    --- FAIL: TestConsumerTestSuite/TestSuccess (0.00s)\n        testcase_stream.go:78: \n                Error Trace:    testcase_stream.go:78\n                                                        testcase_application.go:95\n                                                        testcase_stream.go:57\n                                                        run.go:149\n                Error:          Not equal: \n                                expected: &main.Todo{Id:1, Text:"do it", Status:"pending"}\n                                actual  : &main.Todo{Id:1, Text:"do it!", Status:"pending"}\n                            \n                                Diff:\n                                --- Expected\n                                +++ Actual\n                                @@ -2,3 +2,3 @@\n                                  Id: (int) 1,\n                                - Text: (string) (len=5) "do it",\n                                + Text: (string) (len=6) "do it!",\n                                  Status: (string) (len=7) "pending"\n                Test:           TestConsumerTestSuite/TestSuccess\n                Messages:       body does not match\nFAIL\n'})}),"\n",(0,r.jsx)(t.p,{children:"This provides a detailed explanation of the test failure."}),"\n",(0,r.jsx)(t.h2,{id:"conclusion",children:"Conclusion"}),"\n",(0,r.jsx)(t.p,{children:"You're done! You created your first integration test with gosoline."}),"\n",(0,r.jsx)(t.p,{children:"Check out these resources to learn more about testing and creating consumers with gosoline:"}),"\n",(0,r.jsxs)(t.ul,{children:["\n",(0,r.jsx)(t.li,{children:(0,r.jsx)(t.a,{href:"/quickstart/create-a-consumer",children:"Create a consumer"})}),"\n",(0,r.jsx)(t.li,{children:(0,r.jsx)(t.a,{href:"/how-to/write-integration-tests",children:"Write integration tests"})}),"\n"]})]})}function h(e={}){let{wrapper:t}={...(0,i.R)(),...e.components};return t?(0,r.jsx)(t,{...e,children:(0,r.jsx)(l,{...e})}):l(e)}}}]);