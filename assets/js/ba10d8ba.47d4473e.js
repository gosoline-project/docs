"use strict";(self.webpackChunkgosoline_docs=self.webpackChunkgosoline_docs||[]).push([["2225"],{2918(e,n,t){t.r(n),t.d(n,{metadata:()=>r,default:()=>g,frontMatter:()=>a,contentTitle:()=>d,toc:()=>h,assets:()=>c});var r=JSON.parse('{"id":"how-to/logging/log-context","title":"Use context with logs","description":"The go Context carries data from the moment the server receives an inbound request to the moment the server makes an outbound request. This means you can use it to propagate data between services and processes. With gosoline, you can use log functions to store data from the request lifecycle in the Context and attach that data to logs to provide more details.","source":"@site/docs/how-to/logging/log-context.mdx","sourceDirName":"how-to/logging","slug":"/how-to/logging/log-context","permalink":"/docs/how-to/logging/log-context","draft":false,"unlisted":false,"editUrl":"https://github.com/gosoline-project/docs/tree/main/docs/how-to/logging/log-context.mdx","tags":[],"version":"current","sidebarPosition":5,"frontMatter":{"sidebar_position":5,"title":"Use context with logs"},"sidebar":"docSidebar","previous":{"title":"Sampling & fingers-crossed","permalink":"/docs/how-to/logging/sampling-and-fingers-crossed"},"next":{"title":"Implement a log handler","permalink":"/docs/how-to/logging/implement-a-log-handler"}}'),o=t(4848),s=t(8453),i=t(4490);let l='package main\n\nimport (\n	"context"\n	"fmt"\n	"time"\n\n	"github.com/justtrackio/gosoline/pkg/cfg"\n	"github.com/justtrackio/gosoline/pkg/db-repo"\n	"github.com/justtrackio/gosoline/pkg/httpserver/crud"\n	"github.com/justtrackio/gosoline/pkg/log"\n	"github.com/justtrackio/gosoline/pkg/mdl"\n)\n\nvar settings = db_repo.Settings{\n	Metadata: db_repo.Metadata{\n		ModelId: mdl.ModelId{\n			Name: "todo",\n		},\n		TableName:  "todos",\n		PrimaryKey: "todos.id",\n	},\n}\n\ntype Todo struct {\n	db_repo.Model\n	Text    string\n	DueDate time.Time\n}\n\ntype CreateInput struct {\n	Text    string    `form:"text"`\n	DueDate time.Time `form:"dueDate"`\n}\n\ntype UpdateInput struct {\n	Text string `form:"text"`\n}\n\n// snippet-start: crud handler v0\ntype TodoCrudHandlerV0 struct {\n	// highlight-next-line\n	logger log.Logger\n	repo   db_repo.Repository\n}\n\n// snippet-end: crud handler v0\n\n// snippet-start: new todo crud handler\nfunc NewTodoCrudHandler(ctx context.Context, config cfg.Config, logger log.Logger) (*TodoCrudHandlerV0, error) {\n	var err error\n	var repo db_repo.Repository\n\n	if repo, err = db_repo.New(ctx, config, logger, settings); err != nil {\n		return nil, fmt.Errorf("can not create db_repo.Repositorys: %w", err)\n	}\n\n	handler := &TodoCrudHandlerV0{\n		// highlight-next-line\n		logger: logger,\n		repo:   repo,\n	}\n\n	return handler, nil\n}\n\n// snippet-end: new todo crud handler\n\nfunc (h TodoCrudHandlerV0) GetRepository() crud.Repository {\n	return h.repo\n}\n\nfunc (h TodoCrudHandlerV0) GetModel() db_repo.ModelBased {\n	return &Todo{}\n}\n\nfunc (h TodoCrudHandlerV0) GetCreateInput() any {\n	return &CreateInput{}\n}\n\n// snippet-start: truncate\nfunc truncate(ctx context.Context, text string) string {\n	r := []rune(text)\n	length := len(r)\n\n	log.MutateContextFields(ctx, map[string]any{\n		"original_length": length,\n	})\n\n	if length > 50 {\n		text = string(r[:50]) + "..."\n	}\n\n	return text\n}\n\n// snippet-end: truncate\n\n// snippet-start: transform create\nfunc (h TodoCrudHandlerV0) TransformCreate(ctx context.Context, input any, model db_repo.ModelBased) error {\n	in := input.(*CreateInput)\n	m := model.(*Todo)\n\n	// highlight-start\n	localctx := log.InitContext(ctx)\n	m.Text = truncate(localctx, in.Text)\n	// highlight-end\n	m.DueDate = in.DueDate\n\n	return nil\n}\n\n// snippet-end: transform create\n\nfunc (h TodoCrudHandlerV0) GetUpdateInput() any {\n	return &UpdateInput{}\n}\n\n// snippet-start: transform update\nfunc (h TodoCrudHandlerV0) TransformUpdate(ctx context.Context, input any, model db_repo.ModelBased) error {\n	in := input.(*UpdateInput)\n	m := model.(*Todo)\n\n	// highlight-start\n	localctx := log.InitContext(ctx)\n	m.Text = truncate(localctx, in.Text)\n	// highlight-end\n\n	return nil\n}\n\n// snippet-end: transform update\n\nfunc (h TodoCrudHandlerV0) TransformOutput(ctx context.Context, model db_repo.ModelBased, apiView string) (any, error) {\n	return model, nil\n}\n\nfunc (h TodoCrudHandlerV0) List(ctx context.Context, qb *db_repo.QueryBuilder, apiView string) (any, error) {\n	var err error\n\n	// Instatiate a list of Todo objects, called result.\n	result := make([]*Todo, 0)\n\n	// Query the database using a Context and a QueryBuilder. If it finds the results, it sets them on result. Otherwise, it returns an error.\n	if err = h.repo.Query(ctx, qb, &result); err != nil {\n		return nil, fmt.Errorf("can not query todo items: %w", err)\n	}\n\n	// Transform each result with TransformOutput().\n	out := make([]any, len(result))\n	for i, res := range result {\n		if out[i], err = h.TransformOutput(ctx, res, apiView); err != nil {\n			return nil, err\n		}\n	}\n\n	// Return the transformed results.\n	return out, nil\n}\n',a={sidebar_position:5,title:"Use context with logs"},d,c={},h=[{value:"Before you begin",id:"before-you-begin",level:2},{value:"Truncate todo text",id:"truncate-todo-text",level:2},{value:"Use your new function",id:"use-your-new-function",level:2},{value:"Use your <code>Context</code> with logs",id:"use-your-context-with-logs",level:2},{value:"Test your work",id:"test-your-work",level:2},{value:"Start MySQL",id:"start-mysql",level:3},{value:"Run your server",id:"run-your-server",level:3},{value:"Make requests",id:"make-requests",level:3},{value:"Conclusion",id:"conclusion",level:2}];function u(e){let n={a:"a",admonition:"admonition",code:"code",h2:"h2",h3:"h3",li:"li",ol:"ol",p:"p",pre:"pre",ul:"ul",...(0,s.R)(),...e.components};return(0,o.jsxs)(o.Fragment,{children:[(0,o.jsxs)(n.p,{children:["The ",(0,o.jsx)(n.a,{href:"https://pkg.go.dev/context",children:"go Context"})," carries data from the moment the server receives an inbound request to the moment the server makes an outbound request. This means you can use it to propagate data between services and processes. With gosoline, you can use log functions to store data from the request lifecycle in the Context and attach that data to logs to provide more details."]}),"\n",(0,o.jsx)(n.p,{children:'In this guide, you\'ll add some logs to a CRUD server used for managing a "To do list".'}),"\n",(0,o.jsx)(n.h2,{id:"before-you-begin",children:"Before you begin"}),"\n",(0,o.jsxs)(n.p,{children:["Before you begin, make sure you have ",(0,o.jsx)(n.a,{href:"https://go.dev/doc/install",children:"Golang"})," installed on your machine."]}),"\n",(0,o.jsx)(n.h2,{id:"truncate-todo-text",children:"Truncate todo text"}),"\n",(0,o.jsx)(n.p,{children:"With this service, users can create, read, update, and delete todos. For the purposes of this tutorial, you'll add some new logic. Instead of accepting any text for a todo, you'll limit the length of that string to prevent users from posting huge amounts of text in their todos."}),"\n",(0,o.jsxs)(n.p,{children:["In ",(0,o.jsx)(n.code,{children:"handler.go"}),", add a new function:"]}),"\n",(0,o.jsx)(i.N,{title:"handler.go",language:"go",snippet:"truncate",children:l}),"\n",(0,o.jsx)(n.p,{children:"In this function, you:"}),"\n",(0,o.jsxs)(n.ol,{children:["\n",(0,o.jsxs)(n.li,{children:["Accept a ",(0,o.jsx)(n.code,{children:"Context"})," and a string as arguments"]}),"\n",(0,o.jsx)(n.li,{children:"Capture the length of the string"}),"\n",(0,o.jsxs)(n.li,{children:["Mutate the ",(0,o.jsx)(n.code,{children:"Context"})," to store the original length of the string"]}),"\n",(0,o.jsx)(n.li,{children:"Truncate the string if it is longer than 50 runes."}),"\n",(0,o.jsx)(n.li,{children:"Return the potentially truncated string"}),"\n"]}),"\n",(0,o.jsxs)(n.p,{children:["For this tutorial, the important thing to pay attention to is where you mutate the ",(0,o.jsx)(n.code,{children:"Context"}),":"]}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-go",children:'log.MutateContextFields(ctx, map[string]any{\n	"original_length": length,\n})\n'})}),"\n",(0,o.jsxs)(n.p,{children:["With Gosoline, you can initilize specific fields that you can use with a ",(0,o.jsx)(n.code,{children:"Logger"}),". (You'll do this in the next step.) Once those fields are initialized, you can append or mutate the fields as you've done here."]}),"\n",(0,o.jsx)(n.admonition,{type:"info",children:(0,o.jsxs)(n.p,{children:["Read more about appending and mutating context fields in our ",(0,o.jsx)(n.a,{href:"/reference/package-log#appendcontextfields",children:"log package reference"}),"."]})}),"\n",(0,o.jsx)(n.h2,{id:"use-your-new-function",children:"Use your new function"}),"\n",(0,o.jsxs)(n.p,{children:["Now that you have a function that can truncate todo text, use it in ",(0,o.jsx)(n.code,{children:"TransformCreate()"}),":"]}),"\n",(0,o.jsx)(i.N,{title:"handler.go",language:"go",snippet:"transform create",children:l}),"\n",(0,o.jsxs)(n.p,{children:["Then, use it in ",(0,o.jsx)(n.code,{children:"TransformUpdate()"}),":"]}),"\n",(0,o.jsx)(i.N,{title:"handler.go",language:"go",snippet:"transform update",children:l}),"\n",(0,o.jsxs)(n.p,{children:["Here, you first call ",(0,o.jsx)(n.code,{children:"log.InitContext()"}),". This function creates two sets of log-related fields in the ",(0,o.jsx)(n.code,{children:"Context"}),":"]}),"\n",(0,o.jsxs)(n.ul,{children:["\n",(0,o.jsxs)(n.li,{children:[(0,o.jsx)(n.code,{children:"localFields"}),": These fields are limited to the application in which they are set. They are not propagated to downstream services in any way."]}),"\n",(0,o.jsxs)(n.li,{children:[(0,o.jsx)(n.code,{children:"globalFields"}),": These fields aren't limited to the application in which they are set. They are propagated to downstream services."]}),"\n"]}),"\n",(0,o.jsxs)(n.p,{children:["Then, it returns a ",(0,o.jsx)(n.code,{children:"Context"})," in which these local and global fields are mutable. You pass this ",(0,o.jsx)(n.code,{children:"Context"})," as the first parameter to ",(0,o.jsx)(n.code,{children:"truncate()"}),"."]}),"\n",(0,o.jsx)(n.p,{children:":::info Technical Detail"}),"\n",(0,o.jsxs)(n.p,{children:["Actually, this call to ",(0,o.jsx)(n.code,{children:"log.InitContext()"})," is not required because gosoline will have already initialized the ",(0,o.jsx)(n.code,{children:"Context"})," earlier in the request lifecycle (specifically, in the HTTP middleware). In this case, the ",(0,o.jsx)(n.code,{children:"ctx"})," you pass to ",(0,o.jsx)(n.code,{children:"log.InitContext()"})," is returned, unchanged. Therefore, ",(0,o.jsx)(n.code,{children:"localctx"})," and ",(0,o.jsx)(n.code,{children:"ctx"})," are the same, so you could have passed ",(0,o.jsx)(n.code,{children:"ctx"})," to ",(0,o.jsx)(n.code,{children:"truncate()"})," instead."]}),"\n",(0,o.jsxs)(n.p,{children:["However, this example illustrates where to call ",(0,o.jsx)(n.code,{children:"log.InitContext()"})," if you were to create or receive a ",(0,o.jsx)(n.code,{children:"Context"})," from somewhere else (e.g., in a background job or CLI command). If you initialized the ",(0,o.jsx)(n.code,{children:"Context"})," inside ",(0,o.jsx)(n.code,{children:"truncate()"}),", the log-related fields would go out of scope when the function returns. Instead, you initilize the ",(0,o.jsx)(n.code,{children:"Context"})," and pass it in, so you can make use of the log-related fields later."]}),"\n",(0,o.jsx)(n.p,{children:":::"}),"\n",(0,o.jsxs)(n.h2,{id:"use-your-context-with-logs",children:["Use your ",(0,o.jsx)(n.code,{children:"Context"})," with logs"]}),"\n",(0,o.jsxs)(n.p,{children:["If you run your service now, you'll see the results of your work. Gosoline has some built-in logs that will show your ",(0,o.jsx)(n.code,{children:"Context"})," fields. However, you can also manually add the ",(0,o.jsx)(n.code,{children:"Context"})," to a new logger."]}),"\n",(0,o.jsxs)(n.p,{children:["First, add a logger to your ",(0,o.jsx)(n.code,{children:"TodoCrudHandlerV0"}),":"]}),"\n",(0,o.jsx)(i.N,{title:"handler.go",language:"go",snippet:"crud handler v0",children:l}),"\n",(0,o.jsx)(n.p,{children:"Now, you can make use of this logger in any of the handler's methods."}),"\n",(0,o.jsx)(n.p,{children:"Next, when you initilize the handler, pass a logger:"}),"\n",(0,o.jsx)(i.N,{title:"handler.go",language:"go",snippet:"new todo crud handler",children:l}),"\n",(0,o.jsxs)(n.p,{children:["Finally, in ",(0,o.jsx)(n.code,{children:"TransformCreate()"})," or ",(0,o.jsx)(n.code,{children:"TransformUpdate()"}),", you can use the logger:"]}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-go",metastring:"title=handler.go",children:'\nh.logger.Info(localctx, "creating new task due at %v", m.DueDate)\n\n'})}),"\n",(0,o.jsxs)(n.p,{children:["Here, you pass the ",(0,o.jsx)(n.code,{children:"Context"})," to the logger."]}),"\n",(0,o.jsx)(n.h2,{id:"test-your-work",children:"Test your work"}),"\n",(0,o.jsx)(n.p,{children:"Now it's time to test your work."}),"\n",(0,o.jsx)(n.h3,{id:"start-mysql",children:"Start MySQL"}),"\n",(0,o.jsx)(n.p,{children:"First, start your MySQL container:"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-shell",children:"docker-compose up\n"})}),"\n",(0,o.jsxs)(n.p,{children:["Now, you have a MySQL database running in a container. You can see it running on port 3306 with ",(0,o.jsx)(n.code,{children:"docker ps"})," in another shell:"]}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-shell",children:'CONTAINER ID   IMAGE          COMMAND                  CREATED          STATUS          PORTS                               NAMES\nccf507fd70e4   mysql:8.0.31   "docker-entrypoint.s\u2026"   10 minutes ago   Up 10 minutes   0.0.0.0:3306->3306/tcp, 33060/tcp   write-crud-sql-app-mysql-1\n'})}),"\n",(0,o.jsx)(n.h3,{id:"run-your-server",children:"Run your server"}),"\n",(0,o.jsxs)(n.p,{children:["In another shell, navigate to the root ",(0,o.jsx)(n.code,{children:"crud"})," directory of this project and spin up your server:"]}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-shell",children:"go mod init crud/m\ngo mod tidy\ngo run .\n"})}),"\n",(0,o.jsx)(n.p,{children:"You'll see logs of your server running."}),"\n",(0,o.jsx)(n.h3,{id:"make-requests",children:"Make requests"}),"\n",(0,o.jsx)(n.p,{children:"Finally, in a third shell, make requests to your service. For example, create a todo:"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-shell",children:'curl -d \'{"text":"do it!", "dueDate":"2023-09-08T15:00:00Z"}\' -H "Content-Type: application/json" -X POST localhost:8080/v0/todo\n'})}),"\n",(0,o.jsx)(n.p,{children:"Update the todo:"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-shell",children:'curl -d \'{"text":"do it!!!"}\' -H "Content-Type: application/json" -X PUT localhost:8080/v0/todo/1\n'})}),"\n",(0,o.jsxs)(n.p,{children:["In your logs, you should see the ",(0,o.jsx)(n.code,{children:"original_length"})," field you added in the first step:"]}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-js",children:"13:32:05.145 http    info    POST /v0/todo HTTP/1.1\n// highlight-next-line\noriginal_length: 115 \napplication: server\nbytes: 174\nclient_ip: 127.0.0.1\ngroup: crud\nhost:\nlocalhost:8080\nprotocol: HTTP/1.1\nrequest_bytes: 160\nrequest_method: POST\nrequest_path: /v0/todo\nrequest_path_raw: /v0/todo\nrequest_query: \nrequest_query_parameters: map[]\nrequest_referer: \nrequest_time: 0.011703875\nrequest_user_agent: curl/8.1.2\nscheme: http\nstatus: 200\n"})}),"\n",(0,o.jsx)(n.p,{children:"This is included in the log because we automatically resolve the local and global fields and include them in the log output."}),"\n",(0,o.jsx)(n.p,{children:"If you need to create a new logger, you have to resolve the fields yourself. However, we've made this easy for you. Just pass the context to the logger:"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-go",children:'logger := log.NewLogger()\nlogger.Info(ctx, "My message with context")\n'})}),"\n",(0,o.jsx)(n.h2,{id:"conclusion",children:"Conclusion"}),"\n",(0,o.jsx)(n.p,{children:"Great work! In this tutorial, you used Gosoline to add some context to your logs."})]})}function g(e={}){let{wrapper:n}={...(0,s.R)(),...e.components};return n?(0,o.jsx)(n,{...e,children:(0,o.jsx)(u,{...e})}):u(e)}},4490(e,n,t){t.d(n,{N:()=>y,v:()=>j});var r=t(4848);t(6540);var o=t(5875),s=t(1083),i=t(3773),l=t(5681),a=t(8055),d=t(6311),c=t(7625),h=t(5638),u=t(6645),g=t(1113),p=t(6582),x=t(7312),m=t(3941),f=t(6497);function j(){let{colorMode:e}=(0,m.G)(),n=(0,p.A)({palette:{mode:"dark"===e?"dark":"light"}});return(0,r.jsx)(x.A,{theme:n,children:(0,r.jsxs)(h.Ay,{container:!0,spacing:4,children:[(0,r.jsx)(h.Ay,{item:!0,xs:12,s:12,md:4,children:(0,r.jsxs)(o.A,{style:{height:"100%"},children:[(0,r.jsx)(i.A,{title:"HTTP Server",avatar:(0,r.jsx)(u.default,{}),titleTypographyProps:{variant:"h6"}}),(0,r.jsx)(l.A,{children:"Build REST web services with HTTP handling, caching, OAuth, and much more."}),(0,r.jsx)(s.A,{children:(0,r.jsx)(a.A,{size:"small",href:(0,f.Ay)("/category/http-server"),children:"Get started"})})]})}),(0,r.jsx)(h.Ay,{item:!0,xs:12,md:4,children:(0,r.jsxs)(o.A,{style:{height:"100%"},children:[(0,r.jsx)(i.A,{title:"Message Queues",avatar:(0,r.jsx)(d.default,{}),titleTypographyProps:{variant:"h6"}}),(0,r.jsx)(l.A,{children:"Process asynchronous messages from Kafka, Redis, or any other queuing or streaming system."}),(0,r.jsx)(s.A,{children:(0,r.jsx)(a.A,{size:"small",href:(0,f.Ay)("/quickstart/create-a-consumer"),children:"Get started"})})]})}),(0,r.jsx)(h.Ay,{item:!0,xs:12,md:4,children:(0,r.jsxs)(o.A,{style:{height:"100%"},children:[(0,r.jsx)(i.A,{title:"Kernel Module",avatar:(0,r.jsx)(c.default,{}),titleTypographyProps:{variant:"h6"}}),(0,r.jsx)(l.A,{children:"Implement a kernel module with which you can do anything, using gosoline's logging, configuration, and other solutions."}),(0,r.jsx)(s.A,{children:(0,r.jsx)(a.A,{size:"small",href:(0,f.Ay)("/quickstart/create-an-application"),children:"Get started"})})]})})]})})}function y({children:e,snippet:n,...t}){let o=e.replace(/\n$/,"");if(n){let e=RegExp(`(?://|#) snippet-start: ${n}s*
(.*)(?://|#) snippet-end: ${n}s*$`,"sm"),t=o.match(e);t&&(o=t[1])}for(o=o.split("\n").filter(function(e){return!RegExp("w*?(?://|#) snippet.*\n*?$","g").test(e)});o.length>0&&""===o[0].trim();)o=o.slice(1);for(;o.length>0&&""===o[o.length-1].trim();)o=o.slice(0,-1);let s=(o=(o=o.join("\n")).replace(/^\t+/gm,e=>"  ".repeat(e.length))).split("\n"),i=s.filter(e=>e.trim().length>0).reduce((e,n)=>Math.min(e,n.match(/^(\s*)/)[1].length),1/0);return i>0&&i!==1/0&&(o=s.map(e=>e.slice(i)).join("\n")),(0,r.jsx)(g.A,{...t,children:o})}}}]);